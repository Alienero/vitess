<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - ReplicationGraph</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/ReplicationGraph/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

<link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

</head>
<body class="">

<header id="app-bar" class="app-bar promote-layer">
  <div class="app-bar-container">
    <button id="menu" class="menu" title="Menu"></button>
    <h1 class="logo"><a href="/">Vitess</a></h1>
    <section class="app-bar-actions">
      <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
    </section>
  </div>
</header>

<div class="navdrawer">
  <nav id="nav" class="navdrawer-container promote-layer">
    <h4>Navigation</h4>
    
<ul>
  
    <li >
      <a href="http://vitess.io//"></a>
    </li>
  
    <li >
      <a href="http://vitess.io/overview/">Overview</a>
    </li>
  
    <li >
      <a href="http://vitess.io/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

  </nav>
</div>

<main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">ReplicationGraph</h2>
    
  </header>

  <div class="container">
    <h1 id="replication-graph">Replication Graph</h1>

<p>The replication graph contains the mysql replication information for a shard. Currently, we only support one layer
of replication (a single master with multiple slaves), but the design doesn&#39;t preclude us from supporting
hierarchical replication later on.</p>

<h2 id="master">Master</h2>

<p>The current master for a shard is represented in the Shard object as MasterAlias, in the global topology server.</p>

<p>When creating a master (using &#39;vtctl InitTablet ... master&#39;), we make sure MasterAlias is empty in the Shard record, and refuse to proceed if not (unless -force-master is specified). After creation, we update MasterAlias in the Shard.</p>

<h2 id="slaves">Slaves</h2>

<p>The slaves are added to the ShardReplication object present on each local topology server. So for slaves, the
replication graph is colocated in the same cell as the tablets themselves. This makes disaster recovery much easier:
when losing a data center, the replication graph for other data centers is not lost.</p>

<p>When creating a slave (using &#39;vtctl InitTablet ... replica&#39; for instance), we get the master record (if not specified) from the MasterAlias of the Shard. We then add an entry in the ReplicationLinks list of the ShardReplication object for the tablet’s cell (we create ShardReplication if it doesn’t exist yet).</p>

<h2 id="discovery">Discovery</h2>

<p>When looking for all the tablets in a Shard, we look for the Shard record, start the list with the MasterAlias, and read the &#39;Cells&#39; list. Then for each Cell, we get the ShardReplication object, and find all the tablets, and add them to the list.</p>

<p>If a cell is down, the result is partial. Some actions are resilient to partial results, like reparenting.</p>

<h2 id="reparenting">Reparenting</h2>

<p><a href="http://vitess.io/doc/Reparenting">Reparenting</a> will update the MasterAlias record in the Shard (after having acquired the Shard lock). See the Reparenting doc for more information.</p>

  </div>

</main>


<footer>
  <div class="container">
    <p class="small">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  </div>
</footer>

<script src="/assets/scripts/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

</body>
</html>

