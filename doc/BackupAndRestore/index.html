<!DOCTYPE html>
<html lang="en-US">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width" />
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - BackupAndRestore</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/BackupAndRestore/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

      <link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

      <link rel="stylesheet" href="/css/components.css">
      <link rel="stylesheet" href="/css/responsee.css">
      <!-- CUSTOM STYLE -->
      <link rel="stylesheet" href="/css/template-style.css">
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
      <script type="text/javascript" src="/assets/scripts/jquery-1.8.3.min.js"></script>
      <script type="text/javascript" src="/assets/scripts/jquery-ui.min.js"></script>    
      <script type="text/javascript" src="/assets/scripts/modernizr.js"></script>
      <script type="text/javascript" src="/assets/scripts/responsee.js"></script>
      <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
   </head>
   <body class="size-1140">
      <header id="app-bar" class="app-bar promote-layer">
         <div class="line">
            <div class="app-bar-container">
               <button id="menu" class="menu" title="Menu"></button>
               <h1 class="logo"><a href="/">Vitess</a></h1>
               <section class="app-bar-actions">
                  <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
               </section>
            </div>
            <div class="navdrawer">
              <nav id="nav" class="navdrawer-container promote-layer">
                <h4>Navigation</h4>
                
<ul>
  
    <li >
      <a href="//"></a>
    </li>
  
    <li >
      <a href="/overview/">Overview</a>
    </li>
  
    <li >
      <a href="/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

              </nav>
            </div>
         </div>
      </header>
      <!-- ASIDE NAV AND CONTENT -->
      <div class="line">
         <div class="box  margin-bottom">
            <div class="margin">
               <!-- ASIDE NAV 2 -->
               <nav class="scrolling-nav" style="margin:0">
               <aside class="s-12">
                  <div class="aside-nav">
                     <div class="aside-nav-header">Overview</div>
                     <ul>
                        <li><a href="/overview/">What is Vitess</a></li>
                        <li><a href="/overview/concepts.html">Key Concepts</a></li>
                     </ul>
                     <div class="aside-nav-header">Getting Started</div>
                     <ul>
                        <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
                        <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
                     </ul>
                     <div class="aside-nav-header">User Guide</div>
                     <ul>
                        <li><a href="/user-guide/sharding.html">Sharding</a>
                          <ul>
                            <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                            <li><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
                          </ul>
                        </li>
<!--
                        <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
                        <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
                        <li><a href="/user-guide/storage.html">Storage</a></li>
                        <li><a href="/user-guide/api.html">Using the API</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Architecture</div>
                     <ul>
                        <li><a href="/architecture/life-of-a-query.html">Life of a Query</a></li>
                        <li><a href="/architecture/topology-service.html">Topology Service</a></li>
                     </ul>

                     <div class="aside-nav-header">Maintenance</div>
                     <ul>
                        <li><a href="/maintenance/monitoring.html">Monitoring</a></li>
                        <li><a href="/maintenance/testing.html">Testing</a></li>
                     </ul>
-->
                     <div class="aside-nav-header">Reference</div>
                     <ul>
                        <li><a href="/reference/vtctl.html">vtctl Reference</a></li>
<!--
                        <li><a href="/reference/api.html">API Reference</a></li>
                        <li><a href="/reference/client-libraries/">Client Libraries</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Other Resources</div>
                     <ul>
                        <li><a href="/resources/presentations.html">Presentations</a></li>
                        <li class="last"><a href="/resources/roadmap.html">Roadmap</a></li>
                     </ul>
                  </div>
-->
               </aside>
               </nav>
               <!-- CONTENT -->
               <section class="s-12 l-9">
                 <main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">BackupAndRestore</h2>
    
  </header>

  <div class="container">
    <h1 id="backup-and-restore">Backup and Restore</h1>

<p>This document describes Vitess Backup and Restore strategy.</p>

<h3 id="overview">Overview</h3>

<p>Backups are used in Vitess for two purposes: to provide a point-in-time backup for the data, and to bootstrap new instances.</p>

<h3 id="backup-storage">Backup Storage</h3>

<p>Backups are stored on a Backup Storage service. Vitess core software contains an implementation that uses a local filesystem to store the files. Any network-mounted drive can then be used as the repository for backups.</p>

<p>We have plans to implement a version of the Backup Storage service for Google Cloud Storage (contact us if you are interested).</p>

<p>(The interface definition for the Backup Storage service is in <a href="https://github.com/youtube/vitess/blob/master/go/vt/mysqlctl/backupstorage/interface.go">interface.go</a>, see comments there for more details).</p>

<p>Concretely, the following command line flags are used for Backup Storage:</p>

<ul>
<li>-backup_storage_implementation: which implementation of the Backup Storage interface to use.</li>
<li>-file_backup_storage_root: the root of the backups if &#39;file&#39; is used as a Backup Storage.</li>
</ul>

<h3 id="taking-a-backup">Taking a Backup</h3>

<p>To take a backup is very straightforward: just run the &#39;vtctl Backup <tablet-alias>&#39; command. The designated tablet will take itself out of the healthy serving tablets, shutdown its mysqld process, copy the necessary files to the Backup Storage, restart mysql, restart replication, and join the cluster back.</p>

<p>With health-check enabled (the recommended default), the tablet goes back to spare state. Once it catches up on replication, it will go back to a serving state.</p>

<p>Note for this to work correctly, the tablet must be started with the right parameters to point it to the Backup Storage system (see previous section).</p>

<h3 id="life-of-a-shard">Life of a Shard</h3>

<p>To illustrate how backups are used in Vitess to bootstrap new instances, let&#39;s go through the creation and life of a Shard:</p>

<ul>
<li>A shard is initially brought up with no existing backup. All instances are started as replicas. With health-check enabled (the recommended default), each instance will realize replication is not running, and just stay unhealthy as spare.</li>
<li>Once a few replicas are up, InitShardMaster is run, one host becomes the master, the others replicas. Master becomes healthy, replicas are not as no database exists.</li>
<li>Initial schema can then be applied to the Master. Either use the usual Schema change tools, or use CopySchemaShard for shards created as targets for resharding.</li>
<li>After replicating the schema creation, all replicas become healthy. At this point, we have a working and functionnal shard.</li>
<li>The initial backup is taken (that stores the data and the current replication position), and backup data is copied to a network storage.</li>
<li>When a replica comes up (either a new replica, or one whose instance was just restarted), it restores the latest backup, resets its master to the current shard master, and starts replicating.</li>
<li>A Cronjob to backup the data on a regular basis should then be run. The frequency of the backups should be high enough (compared to MySQL binlog retention), so we can always have a backup to fall back upon.</li>
</ul>

<p>Restoring a backup is enabled by the --restore_from_backup command line option in vttablet. It can be enabled all the time for all the tablets in a shard, as it doesn&#39;t prevent vttablet from starting if no backup can be found.</p>

<h3 id="backup-management">Backup Management</h3>

<p>Two vtctl commands exist to manage the backups:</p>

<ul>
<li>&#39;vtctl ListBackups <keyspace/shard>&#39; will display the existing backups for a keyspace/shard in the order they were taken (oldest first).</li>
<li>&#39;vtctl RemoveBackup <keyspace/shard> <backup name>&#39; will remove a backup from Backup Storage.</li>
</ul>

<h3 id="details">Details</h3>

<p>Both Backup and Restore copy and compress / decompress multiple files simultaneously to increase throughput. The concurrency can be controlled by command-line flags (-concurrency for &#39;vtctl Backup&#39;, and -restore_concurrency for vttablet). If the network link is fast enough, the concurrency will match the CPU usage of the process during backup / restore.</p>

  </div>

</main>

               </section>
            </div>
         </div>
         <footer>
            <div class="s-12">
               <div style="float: left; display: inline-block; width: 50%;">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</div>
               <div style="float: right; display: inline-block; text-align: right; width: 50%;">Design and coding based on <a href="http://www.myresponsee.com" title="Responsee - lightweight responsive framework">Responsee</a> framework</div>
               </div>
         </footer>
      </div>
      <!-- FOOTER -->

      <script src="/assets/scripts/main.js"></script>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

   </body>
</html>
