<!DOCTYPE html>
<html lang="en-US">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width" />
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - SchemaManagement</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/SchemaManagement/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

      <link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

      <link rel="stylesheet" href="/css/components.css">
      <link rel="stylesheet" href="/css/responsee.css">
      <!-- CUSTOM STYLE -->
      <link rel="stylesheet" href="/css/template-style.css">
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
      <script type="text/javascript" src="/assets/scripts/jquery-1.8.3.min.js"></script>
      <script type="text/javascript" src="/assets/scripts/jquery-ui.min.js"></script>    
      <script type="text/javascript" src="/assets/scripts/modernizr.js"></script>
      <script type="text/javascript" src="/assets/scripts/responsee.js"></script>
      <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
   </head>
   <body class="size-1140">
      <header id="app-bar" class="app-bar promote-layer">
         <div class="line">
            <div class="app-bar-container">
               <button id="menu" class="menu" title="Menu"></button>
               <h1 class="logo"><a href="/">Vitess</a></h1>
               <section class="app-bar-actions">
                  <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
               </section>
            </div>
            <div class="navdrawer">
              <nav id="nav" class="navdrawer-container promote-layer">
                <h4>Navigation</h4>
                
<ul>
  
    <li >
      <a href="//"></a>
    </li>
  
    <li >
      <a href="/overview/">Overview</a>
    </li>
  
    <li >
      <a href="/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

              </nav>
            </div>
         </div>
      </header>
      <!-- ASIDE NAV AND CONTENT -->
      <div class="line">
         <div class="box  margin-bottom">
            <div class="margin">
               <!-- ASIDE NAV 2 -->
               <nav class="scrolling-nav" style="margin:0">
               <aside class="s-12">
                  <div class="aside-nav">
                     <div class="aside-nav-header">Overview</div>
                     <ul>
                        <li><a href="/overview/">What is Vitess</a></li>
                        <li><a href="/overview/concepts.html">Key Concepts</a></li>
                     </ul>
                     <div class="aside-nav-header">Getting Started</div>
                     <ul>
                        <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
                        <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
                     </ul>
                     <div class="aside-nav-header">User Guide</div>
                     <ul>
                        <li><a href="/user-guide/sharding.html">Sharding</a>
                          <ul>
                            <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                            <li><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
                          </ul>
                        </li>
<!--
                        <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
                        <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
                        <li><a href="/user-guide/storage.html">Storage</a></li>
                        <li><a href="/user-guide/api.html">Using the API</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Architecture</div>
                     <ul>
                        <li><a href="/architecture/life-of-a-query.html">Life of a Query</a></li>
                        <li><a href="/architecture/topology-service.html">Topology Service</a></li>
                     </ul>

                     <div class="aside-nav-header">Maintenance</div>
                     <ul>
                        <li><a href="/maintenance/monitoring.html">Monitoring</a></li>
                        <li><a href="/maintenance/testing.html">Testing</a></li>
                     </ul>
-->
                     <div class="aside-nav-header">Reference</div>
                     <ul>
                        <li><a href="/reference/vtctl.html">vtctl Reference</a></li>
<!--
                        <li><a href="/reference/api.html">API Reference</a></li>
                        <li><a href="/reference/client-libraries/">Client Libraries</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Other Resources</div>
                     <ul>
                        <li><a href="/resources/presentations.html">Presentations</a></li>
                        <li class="last"><a href="/resources/roadmap.html">Roadmap</a></li>
                     </ul>
                  </div>
-->
               </aside>
               </nav>
               <!-- CONTENT -->
               <section class="s-12 l-9">
                 <main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">SchemaManagement</h2>
    
  </header>

  <div class="container">
    <h1 id="schema-management">Schema Management</h1>

<p>The schema is the list of tables and how to create them. It is managed by vtctl.</p>

<h2 id="looking-at-the-schema">Looking at the Schema</h2>

<p>The following vtctl commands exist to look at the schema, and validate it&#39;s the same on all databases.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">GetSchema &lt;tablet alias&gt;
</code></pre></div>
<p>where &lt;tablet alias&gt; is in the format of &quot;&lt;cell name&gt;-&lt;uid&gt;&quot;</p>

<p>Example:
<code>
$ vtctl -wait-time=30s GetSchema cell01-01234567
</code>
displays the full schema for a tablet</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ValidateSchemaShard &lt;keyspace/shard&gt;
</code></pre></div>
<p>where &lt;keyspace/shard&gt; is the format of &quot;&lt;keyspace&gt;/&lt;shard&gt;&quot;</p>

<p>Example:
<code>
$ vtctl -wait-time=30s ValidateSchemaShard keyspace01/10-20
</code>
validate the master schema matches all the slaves.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ValidateSchemaKeyspace &lt;keyspace&gt;
</code></pre></div>
<p>validate the master schema from shard 0 matches all the other tablets in the keyspace.</p>

<p>Example:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ vtctl -wait-time=30s ValidateSchemaKeyspace user
</code></pre></div>
<h2 id="changing-the-schema">Changing the Schema</h2>

<p>Goals:</p>

<ul>
<li>simplify schema updates on the fleet</li>
<li>minimize human actions / errors</li>
<li>guarantee no or very little downtime for most schema updates</li>
<li>do not store any permanent schema data in Topology Server, just use it for actions.</li>
<li>only look at tables for now (not stored procedures or grants for instance, although they both could be added fairly easily in the same manner)</li>
</ul>

<p>Weâ€™re trying to get reasonable confidence that a schema update is going to work before applying it. Since we cannot really apply a change to live tables without potentially causing trouble, we have implemented a Preflight operation: it copies the current schema into a temporary database, applies the change there to validate it, and gathers the resulting schema. After this Preflight, we have a good idea of what to expect, and we can apply the change to any database and make sure it worked.</p>

<p>The Preflight operation takes a sql string, and returns a SchemaChangeResult:</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">SchemaChangeResult</span> <span class="kd">struct</span> <span class="p">{</span>
 <span class="nx">Error</span>        <span class="kt">string</span>
 <span class="nx">BeforeSchema</span> <span class="o">*</span><span class="nx">SchemaDefinition</span>
 <span class="nx">AfterSchema</span>  <span class="o">*</span><span class="nx">SchemaDefinition</span>
<span class="p">}</span>
</code></pre></div>
<p>The ApplySchema action applies a schema change to a specified keyspace, the performed steps are:</p>

<ul>
<li>It first finds shards belong to this keyspace, including newly added shards in the presence of <a href="Resharding.md">resharding event</a>.</li>
<li>Validate the sql syntax and reject the schema change if the sql 1) Alter more then 100,000 rows, or 2) The targed table has more then 2,000,000 rows. The rational behind this is that ApplySchema simply applies schema changes to the masters; therefore, a big schema change that takes too much time slows down the replication and may reduce the availability of the overall system.</li>
<li>Create a temporary database that has the same schema as the targeted table. Apply the sql to it and makes sure it changes table structure.</li>
<li>Apply the Sql command to the database.</li>
<li>Read the schema again, make sure it is equal to AfterSchema.</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">ApplySchema {-sql=&lt;sql&gt; || -sql_file=&lt;filename&gt;} &lt;keyspace&gt;
</code></pre></div>
  </div>

</main>

               </section>
            </div>
         </div>
         <footer>
            <div class="s-12">
               <div style="float: left; display: inline-block; width: 50%;">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</div>
               <div style="float: right; display: inline-block; text-align: right; width: 50%;">Design and coding based on <a href="http://www.myresponsee.com" title="Responsee - lightweight responsive framework">Responsee</a> framework</div>
               </div>
         </footer>
      </div>
      <!-- FOOTER -->

      <script src="/assets/scripts/main.js"></script>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

   </body>
</html>
