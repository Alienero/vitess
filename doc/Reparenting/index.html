<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - Reparenting</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/Reparenting/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

<link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

</head>
<body class="">

<header id="app-bar" class="app-bar promote-layer">
  <div class="app-bar-container">
    <button id="menu" class="menu" title="Menu"></button>
    <h1 class="logo"><a href="/">Vitess</a></h1>
    <section class="app-bar-actions">
      <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
    </section>
  </div>
</header>

<div class="navdrawer">
  <nav id="nav" class="navdrawer-container promote-layer">
    <h4>Navigation</h4>
    
<ul>
  
    <li >
      <a href="http://vitess.io//"></a>
    </li>
  
    <li >
      <a href="http://vitess.io/overview/">Overview</a>
    </li>
  
    <li >
      <a href="http://vitess.io/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

  </nav>
</div>

<main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">Reparenting</h2>
    
  </header>

  <div class="container">
    <h1 id="reparenting">Reparenting</h1>

<p>This document describes the reparenting features of Vitess. Reparenting is used when the master for a Shard is
changing from one host to another. It can be triggered (for maintenance for instance) or happen automatically
(based on the current master dying for instance).</p>

<p>Two main types of reparenting supported by Vitess are Active Reparents (the Vitess toolchain is handling it all)
and External Reparents (another tool is responsible for reparenting, and the Vitess toolchain just updates its
internal state).</p>

<h2 id="active-reparents">Active Reparents</h2>

<p>They are triggered by using the &#39;vtctl ReparentShard&#39; command. See the help for that command. It currently doesn&#39;t use transaction GroupId.</p>

<h2 id="external-reparents">External Reparents</h2>

<p>In this part, we assume another tool has been reparenting our servers. We then trigger the
&#39;vtctl TabletExternallyReparented&#39; command.</p>

<p>The flow for that command is as follows:
- the shard is locked in the global topology server.
- we read the Shard object from the global topology server.
- we read all the tablets in the replication graph for the shard. Note we allow partial reads here, so if a data center is down, as long as the data center containing the new master is up, we keep going.
- the new master performs a &#39;SlaveWasPromoted&#39; action. This remote action makes sure the new master is not a MySQL slave of another server (the &#39;show slave status&#39; command should not return anything, meaning &#39;reset slave&#39; should have been called).
- for every host in the replication graph, we call the &#39;SlaveWasRestarted&#39; action. It takes as parameter the address of the new master. On each slave, we update the topology server record for that tablet with the new master, and the replication graph for that tablet as well.
- for the old master, if it doesn&#39;t successfully return from &#39;SlaveWasRestarted&#39;, we change its type to &#39;spare&#39; (so a dead old master doesn&#39;t interfere).
- we then update the Shard object with the new master.
- we rebuild the serving graph for that shard. This will update the &#39;master&#39; record for sure, and also keep all the tablets that have successfully reparented.</p>

<p>Failure cases:
- The global topology server has to be available for locking and modification during this operation. If not, the operation will just fail.
- If a single topology server is down in one data center (and it&#39;s not the master data center), the tablets in that data center will be ignored by the reparent. When the topology server comes back up, just re-run &#39;vtctl InitTablet&#39; on the tablets, and that will fix their master record.</p>

<h2 id="reparenting-and-serving-graph">Reparenting And Serving Graph</h2>

<p>When reparenting, we shuffle servers around. A server may get demoted, another promoted, and some servers may end up with the wrong master in the replication graph, or scrapped.</p>

<p>It is important to understand that when we build the serving graph, we go through all the servers in the replication graph, and check their masters. If their master is the one we expect (because it is in the Shard record), we keep going and add them to the serving graph. If not, they are skipped, and a warning is displayed.</p>

<p>When such a slave with the wrong master is present, re-running &#39;vtctl InitTablet&#39; with the right parameters will fix the server. So the order of operations should be to fix mysql replication, make sure it is caught up, run &#39;vtctl InitTablet&#39;, and maybe restart vttablet if needed.</p>

<p>Alternatively, if another reparent happens, and the bad slave recovers and now replicates from the new master, it will be re-added, and resume proper operation.</p>

<p>The old master for reparenting is a specific case. If it doesn&#39;t have the right master during the reparent, it will be scrapped (because it&#39;s not in the replication graph at all, so it would get lost anyway).</p>

  </div>

</main>


<footer>
  <div class="container">
    <p class="small">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  </div>
</footer>

<script src="/assets/scripts/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

</body>
</html>

