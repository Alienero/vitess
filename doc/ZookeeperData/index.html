<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - ZookeeperData</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/ZookeeperData/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

<link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

</head>
<body class="">

<header id="app-bar" class="app-bar promote-layer">
  <div class="app-bar-container">
    <button id="menu" class="menu" title="Menu"></button>
    <h1 class="logo"><a href="/">Vitess</a></h1>
    <section class="app-bar-actions">
      <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
    </section>
  </div>
</header>

<div class="navdrawer">
  <nav id="nav" class="navdrawer-container promote-layer">
    <h4>Navigation</h4>
    
<ul>
  
    <li >
      <a href="http://vitess.io//"></a>
    </li>
  
    <li >
      <a href="http://vitess.io/overview/">Overview</a>
    </li>
  
    <li >
      <a href="http://vitess.io/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

  </nav>
</div>

<main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">ZookeeperData</h2>
    
  </header>

  <div class="container">
    <h1 id="zookeeper-data">Zookeeper Data</h1>

<p>This document describes the information we keep in zookeeper, how it is generated, and how the python client uses it.</p>

<h2 id="keyspace-/-shard-/-tablet-data">Keyspace / Shard / Tablet Data</h2>

<h3 id="keyspace">Keyspace</h3>

<p>Each keyspace is now a global zookeeper path, with sub-directories for its shards and action / actionlog. The Keyspace
object there contains very basic information.</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// see go/vt/topo/keyspace.go for latest version</span>
<span class="kd">type</span> <span class="nx">Keyspace</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// name of the column used for sharding</span>
        <span class="c1">// empty if the keyspace is not sharded</span>
        <span class="nx">ShardingColumnName</span> <span class="kt">string</span>

        <span class="c1">// type of the column used for sharding</span>
        <span class="c1">// KIT_UNSET if the keyspace is not sharded</span>
        <span class="nx">ShardingColumnType</span> <span class="nx">key</span><span class="p">.</span><span class="nx">KeyspaceIdType</span>

        <span class="c1">// ServedFrom will redirect the appropriate traffic to</span>
        <span class="c1">// another keyspace</span>
        <span class="nx">ServedFrom</span> <span class="kd">map</span><span class="p">[</span><span class="nx">TabletType</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text"># NOTE: You need to source zookeeper client config file, like so:
#  export ZK_CLIENT_CONFIG=/path/to/zk/client.conf
$ zk ls /zk/global/vt/keyspaces/ruser
action
actionlog
shards
</code></pre></div>
<p>The path and sub-paths are created by &#39;vtctl CreateKeyspace&#39;.</p>

<p>We use the action and actionlog paths for locking only, no process is actively watching these paths.</p>

<h3 id="shard">Shard</h3>

<p>A shard is a global zookeeper path, with sub-directories for its action / actionlog, and a node for some more data and replication graph.</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// see go/vt/topo/shard.go for latest version</span>
<span class="c1">// A pure data struct for information stored in topology server.  This</span>
<span class="c1">// node is used to present a controlled view of the shard, unaware of</span>
<span class="c1">// every management action. It also contains configuration data for a</span>
<span class="c1">// shard.</span>
<span class="kd">type</span> <span class="nx">Shard</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// There can be only at most one master, but there may be none. (0)</span>
        <span class="nx">MasterAlias</span> <span class="nx">TabletAlias</span>

        <span class="c1">// This must match the shard name based on our other conventions, but</span>
        <span class="c1">// helpful to have it decomposed here.</span>
        <span class="nx">KeyRange</span> <span class="nx">key</span><span class="p">.</span><span class="nx">KeyRange</span>

        <span class="c1">// ServedTypes is a list of all the tablet types this shard will</span>
        <span class="c1">// serve. This is usually used with overlapping shards during</span>
        <span class="c1">// data shuffles like shard splitting.</span>
        <span class="nx">ServedTypes</span> <span class="p">[]</span><span class="nx">TabletType</span>

        <span class="c1">// SourceShards is the list of shards we&#39;re replicating from,</span>
        <span class="c1">// using filtered replication.</span>
        <span class="nx">SourceShards</span> <span class="p">[]</span><span class="nx">SourceShard</span>

        <span class="c1">// Cells is the list of cells that have tablets for this shard.</span>
        <span class="c1">// It is populated at InitTablet time when a tablet is added</span>
        <span class="c1">// in a cell that is not in the list yet.</span>
        <span class="nx">Cells</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// SourceShard represents a data source for filtered replication</span>
<span class="c1">// across shards. When this is used in a destination shard, the master</span>
<span class="c1">// of that shard will run filtered replication.</span>
<span class="kd">type</span> <span class="nx">SourceShard</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// Uid is the unique ID for this SourceShard object.</span>
        <span class="c1">// It is for instance used as a unique index in blp_checkpoint</span>
        <span class="c1">// when storing the position. It should be unique whithin a</span>
        <span class="c1">// destination Shard, but not globally unique.</span>
        <span class="nx">Uid</span> <span class="kt">uint32</span>

        <span class="c1">// the source keyspace</span>
        <span class="nx">Keyspace</span> <span class="kt">string</span>

        <span class="c1">// the source shard</span>
        <span class="nx">Shard</span> <span class="kt">string</span>

        <span class="c1">// The source shard keyrange</span>
        <span class="c1">// If partial, len(Tables) has to be zero</span>
        <span class="nx">KeyRange</span> <span class="nx">key</span><span class="p">.</span><span class="nx">KeyRange</span>

        <span class="c1">// The source table list to replicate</span>
        <span class="c1">// If non-empty, KeyRange must not be partial (must be KeyRange{})</span>
        <span class="nx">Tables</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">$ zk ls /zk/global/vt/keyspaces/ruser/shards/10-20
action
actionlog
nyc-0000200278
</code></pre></div>
<p>We use the action and actionlog paths for locking only, no process is actively watching these paths.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ zk cat /zk/global/vt/keyspaces/ruser/shards/10-20
{
  &quot;MasterAlias&quot;: {
    &quot;Cell&quot;: &quot;nyc&quot;,
    &quot;Uid&quot;: 200278
  },
  &quot;KeyRange&quot;: {
    &quot;Start&quot;: &quot;10&quot;,
    &quot;End&quot;: &quot;20&quot;
  },
 &quot;Cells&quot;: [
    &quot;oe&quot;,
    &quot;yh&quot;
 ]
}
</code></pre></div>
<p>The shard path and sub-directories are created when the first tablet in that shard is created.</p>

<p>The Shard object is changed when we add tablets in unknown cells, or when we change the master.</p>

<h3 id="tablet">Tablet</h3>

<p>A tablet has a path in zookeeper, with its pid file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ zk ls /zk/nyc/vt/tablets/0000200308
pid
</code></pre></div>
<p>A tablet also has a node of type Tablet:</p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// see go/vt/topo/tablet.go for latest version</span>
<span class="kd">type</span> <span class="nx">Tablet</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">Parent</span>      <span class="nx">TabletAlias</span> <span class="c1">// the globally unique alias for our replication parent - zero if this is the global master</span>

        <span class="c1">// What is this tablet?</span>
        <span class="nx">Alias</span> <span class="nx">TabletAlias</span>

        <span class="c1">// Location of the tablet</span>
        <span class="nx">Hostname</span> <span class="kt">string</span>
        <span class="nx">IPAddr</span>   <span class="kt">string</span>

        <span class="c1">// Named port names. Currently supported ports: vt, vts,</span>
        <span class="c1">// mysql.</span>
        <span class="nx">Portmap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>

        <span class="c1">// Tags contain freeform information about the tablet.</span>
        <span class="nx">Tags</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>

        <span class="c1">// Information about the tablet inside a keyspace/shard</span>
        <span class="nx">Keyspace</span> <span class="kt">string</span>
        <span class="nx">Shard</span>    <span class="kt">string</span>
        <span class="nx">Type</span>     <span class="nx">TabletType</span>

        <span class="c1">// Is the tablet read-only?</span>
        <span class="nx">State</span> <span class="nx">TabletState</span>

        <span class="c1">// Normally the database name is implied by &quot;vt_&quot; + keyspace. I</span>
        <span class="c1">// really want to remove this but there are some databases that are</span>
        <span class="c1">// hard to rename.</span>
        <span class="nx">DbNameOverride</span> <span class="kt">string</span>
        <span class="nx">KeyRange</span>       <span class="nx">key</span><span class="p">.</span><span class="nx">KeyRange</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">$ zk cat /zk/nyc/vt/tablets/0000200308
{
  &quot;Alias&quot;: {
    &quot;Cell&quot;: &quot;nyc&quot;,
    &quot;Uid&quot;: 200308,
  },
  &quot;Parent&quot;: {
    &quot;Cell&quot;: &quot;&quot;,
    &quot;Uid&quot;: 0
  },
  &quot;Keyspace&quot;: &quot;&quot;,
  &quot;Shard&quot;: &quot;&quot;,
  &quot;Type&quot;: &quot;idle&quot;,
  &quot;State&quot;: &quot;ReadOnly&quot;,
  &quot;DbNameOverride&quot;: &quot;&quot;,
  &quot;KeyRange&quot;: {
    &quot;Start&quot;: &quot;&quot;,
    &quot;End&quot;: &quot;&quot;
  }
}
</code></pre></div>
<p>The Tablet object is created by &#39;vtctl InitTablet&#39;. Up-to-date information (port numbers, ...) is maintained by the vttablet process. &#39;vtctl ChangeSlaveType&#39; will also change the Tablet record.</p>

<h2 id="replication-graph">Replication Graph</h2>

<p>The data maintained by vt tools is as follows:
- it is stored in the global zk cell
- the master tablet alias is stored in the Shard object
- each cell then has a ShardReplication object that stores to master -&gt; slave pairs.</p>

<h2 id="serving-graph">Serving Graph</h2>

<p>The serving graph for a shard is maintained in every cell that contains tablets for that shard. To get all the available keyspaces in a cell, just list the top-level cell serving graph directory:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ zk ls /zk/nyc/vt/ns
keyspace1
keyspace2
</code></pre></div>
<p>The python client lists that directory at startup to find all the keyspaces.</p>

<h3 id="srvkeyspace">SrvKeyspace</h3>

<p>The keyspace data is stored under <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;</code></p>
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// see go/vt/topo/srvshard.go for latest version</span>
<span class="kd">type</span> <span class="nx">SrvShard</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// Copied from Shard</span>
        <span class="nx">KeyRange</span>    <span class="nx">key</span><span class="p">.</span><span class="nx">KeyRange</span>
        <span class="nx">ServedTypes</span> <span class="p">[]</span><span class="nx">TabletType</span>

        <span class="c1">// TabletTypes represents the list of types we have serving tablets</span>
        <span class="c1">// for, in this cell only.</span>
        <span class="nx">TabletTypes</span> <span class="p">[]</span><span class="nx">TabletType</span>

        <span class="c1">// For atomic updates</span>
        <span class="nx">version</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="c1">// A distilled serving copy of keyspace detail stored in the local</span>
<span class="c1">// cell for fast access. Derived from the global keyspace, shards and</span>
<span class="c1">// local details.</span>
<span class="c1">// In zk, it is in /zk/local/vt/ns/&lt;keyspace&gt;</span>
<span class="kd">type</span> <span class="nx">SrvKeyspace</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// Shards to use per type, only contains complete partitions.</span>
        <span class="nx">Partitions</span> <span class="kd">map</span><span class="p">[</span><span class="nx">TabletType</span><span class="p">]</span><span class="o">*</span><span class="nx">KeyspacePartition</span>

        <span class="c1">// List of available tablet types for this keyspace in this cell.</span>
        <span class="c1">// May not have a server for every shard, but we have some.</span>
        <span class="nx">TabletTypes</span> <span class="p">[]</span><span class="nx">TabletType</span>

        <span class="c1">// Copied from Keyspace</span>
        <span class="nx">ShardingColumnName</span> <span class="kt">string</span>
        <span class="nx">ShardingColumnType</span> <span class="nx">key</span><span class="p">.</span><span class="nx">KeyspaceIdType</span>
        <span class="nx">ServedFrom</span>         <span class="kd">map</span><span class="p">[</span><span class="nx">TabletType</span><span class="p">]</span><span class="kt">string</span>

        <span class="c1">// For atomic updates</span>
        <span class="nx">version</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="c1">// KeyspacePartition represents a continuous set of shards to</span>
<span class="c1">// serve an entire data set.</span>
<span class="kd">type</span> <span class="nx">KeyspacePartition</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// List of non-overlapping continuous shards sorted by range.</span>
        <span class="nx">Shards</span> <span class="p">[]</span><span class="nx">SrvShard</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">$ zk cat /zk/nyc/vt/ns/rlookup
{
  &quot;Shards&quot;: [
    {
      &quot;KeyRange&quot;: {
        &quot;Start&quot;: &quot;&quot;,
        &quot;End&quot;: &quot;&quot;
      },
    }
  ],
  &quot;TabletTypes&quot;: [
    &quot;master&quot;,
    &quot;rdonly&quot;,
    &quot;replica&quot;
  ]
}
</code></pre></div>
<p>The only way to build this data is to run the following vtctl command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ vtctl RebuildKeyspaceGraph &lt;keyspace&gt;
</code></pre></div>
<p>When building a new Cell, this command should be run for every keyspace.</p>

<p>Rebuilding a keyspace graph will:
- find all the shard names in the keyspace from looking at the children of <code>/zk/global/vt/keyspaces/&lt;keyspace&gt;/shards</code>
- rebuild the graph for every shard in the keyspace (see below)
- find the list of cells to update by collecting the cells for each tablet of the first shard
- compute, sanity check and update the keyspace graph object in every cell</p>

<p>The python client reads the nodes to find the shard map (KeyRanges, TabletTypes, ...)</p>

<h3 id="srvshard">SrvShard</h3>

<p>The shard data is stored under <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;/&lt;shard&gt;</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ zk cat /zk/nyc/vt/ns/rlookup/0
{
  &quot;KeyRange&quot;: {
    &quot;Start&quot;: &quot;&quot;,
    &quot;End&quot;: &quot;&quot;
  }
}
</code></pre></div>
<h3 id="endpoints">EndPoints</h3>

<p>We also have per serving type data under <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;/&lt;shard&gt;/&lt;type&gt;</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ zk cat /zk/nyc/vt/ns/rlookup/0/master
{
  &quot;entries&quot;: [
    {
      &quot;uid&quot;: 200274,
      &quot;host&quot;: &quot;nyc-db274.nyc.youtube.com&quot;,
      &quot;port&quot;: 0,
      &quot;named_port_map&quot;: {
        &quot;mysql&quot;: 3306,
        &quot;vt&quot;: 8101,
        &quot;vts&quot;: 8102
      }
    }
  ]
}
</code></pre></div>
<p>The shard serving graph can be re-built using the &#39;vtctl RebuildShardGraph <keyspace>/<shard>&#39; command. However, it is also triggered by any &#39;vtctl ChangeSlaveType&#39; command, so it is usually not needed. For instance, when vt_bns_monitor takes servers in and out of serving state, it will rebuild the shard graph.</p>

<p>Note this will rebuild the serving graph for all cells, not just one cell.</p>

<p>Rebuilding a shard serving graph will:
- compute the data to write by looking at all the tablets from the replication graph
- write all the <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;/&lt;shard&gt;/&lt;type&gt;</code> nodes everywhere
- delete any pre-existing <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;/&lt;shard&gt;/&lt;type&gt;</code> that is not in use any more
- compute and write all the <code>/zk/&lt;cell&gt;/vt/ns/&lt;keyspace&gt;/&lt;shard&gt;</code> nodes everywhere</p>

<p>The clients read the per-type data nodes to find servers to talk to. When resolving ruser.10-20.master, it will try to read /zk/local/vt/ns/ruser/10-20/master.</p>

  </div>

</main>


<footer>
  <div class="container">
    <p class="small">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  </div>
</footer>

<script src="/assets/scripts/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

</body>
</html>

