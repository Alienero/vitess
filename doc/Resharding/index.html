<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - Resharding</title>
<meta name="description" content="A set of servers and tools that facilitate scaling of MySQL databases for the web.">

<link rel="canonical" href="http://vitess.io/doc/Resharding/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

<link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

</head>
<body class="">

<header id="app-bar" class="app-bar promote-layer">
  <div class="app-bar-container">
    <button id="menu" class="menu" title="Menu"></button>
    <h1 class="logo"><a href="/">Vitess</a></h1>
    <section class="app-bar-actions">
      <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
    </section>
  </div>
</header>

<div class="navdrawer">
  <nav id="nav" class="navdrawer-container promote-layer">
    <h4>Navigation</h4>
    
<ul>
  
    <li >
      <a href="http://vitess.io//"></a>
    </li>
  
    <li >
      <a href="http://vitess.io/overview/">Overview</a>
    </li>
  
    <li >
      <a href="http://vitess.io/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

  </nav>
</div>

<main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">Resharding</h2>
    
  </header>

  <div class="container">
    <h1 id="resharding">Resharding</h1>

<p>In Vitess, resharding describes the process of re-organizing data
dynamically, with very minimal downtime (we manage to completely
perform most data transitions with less than 5 seconds of read-only
downtime - new data cannot be written, existing data can still be
read).</p>

<p>See the description of <a href="http://vitess.io/doc/Sharding">how Sharding works in Vitess</a> for
higher level concepts on Sharding.</p>

<h2 id="process">Process</h2>

<p>To follow a step-by-step guide for how to shard a keyspace, you can see <a href="http://vitess.io/doc/HorizontalReshardingGuide">this page</a>.</p>

<p>In general, the process to achieve this goal is composed of the following steps:</p>

<ul>
<li>pick the original shard(s)</li>
<li>pick the destination shard(s) coverage</li>
<li>create the destination shard(s) tablets (in a mode where they are not used to serve traffic yet)</li>
<li>bring up the destination shard(s) tablets, with read-only masters.</li>
<li>backup and split the data from the original shard(s)</li>
<li>merge and import the data on the destination shard(s)</li>
<li>start and run filtered replication from original to destination shard(s), catch up</li>
<li>move the read-only traffic to the destination shard(s), stop serving read-only traffic from original shard(s). This transition can take a few hours. We might want to move rdonly separately from replica traffic.</li>
<li>in quick succession:

<ul>
<li>make original master(s) read-only</li>
<li>flush filtered replication on all filtered replication source servers (after making sure they were caught up with their masters)</li>
<li>wait until replication is caught up on all destination shard(s) masters</li>
<li>move the write traffic to the destination shard(s)</li>
<li>make destination master(s) read-write</li>
</ul></li>
<li>scrap the original shard(s)</li>
</ul>

<h2 id="applications">Applications</h2>

<p>The main application we currently support:</p>

<ul>
<li>in a sharded keyspace, split or merge shards (horizontal sharding)</li>
<li>in a non-sharded keyspace, break out some tables into a different keyspace (vertical sharding)</li>
</ul>

<p>With these supported features, it is very easy to start with a single keyspace containing all the data (multiple tables),
and then as the data grows, move tables to different keyspaces, start sharding some keyspaces, ... without any real
downtime for the application.</p>

<h2 id="scaling-up-and-down">Scaling Up and Down</h2>

<p>Here is a quick table of what to do with Vitess when a change is required:</p>

<ul>
<li>uniformly increase read capacity: add replicas, or split shards</li>
<li>uniformly increase write capacity: split shards</li>
<li>reclaim free space: merge shards / keyspaces</li>
<li>increase geo-diversity: add new cells and new replicas</li>
<li>cool a hot tablet: if read access, add replicas or split shards, if write access, split shards.</li>
</ul>

<h2 id="filtered-replication">Filtered Replication</h2>

<p>The cornerstone of Resharding is being able to replicate the right data. Mysql doesn&#39;t support any filtering, so the
Vitess project implements it entirely:</p>

<ul>
<li>the tablet server tags transactions with comments that describe what the scope of the statements are (which keyspace_id,
which table, ...). That way the MySQL binlogs contain all filtering data.</li>
<li>a server process can filter and stream the MySQL binlogs (using the comments).</li>
<li>a client process can apply the filtered logs locally (they are just regular SQL statements at this point).</li>
</ul>

  </div>

</main>


<footer>
  <div class="container">
    <p class="small">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  </div>
</footer>

<script src="/assets/scripts/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

</body>
</html>

