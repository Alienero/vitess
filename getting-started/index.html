<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / Running Vitess on Kubernetes</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / Running Vitess on Kubernetes"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>
  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Running Vitess on Kubernetes</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <p>This page explains how to run Vitess on <a href="http://kubernetes.io">Kubernetes</a>.
It also gives the steps to start a Kubernetes cluster with
<a href="https://cloud.google.com/container-engine/">Google Container Engine</a>.</p>

<p>If you already have Kubernetes v1.0+ running in one of the other
<a href="http://kubernetes.io/gettingstarted/">supported platforms</a>,
you can skip the <code class="prettyprint">gcloud</code> steps.
The <code class="prettyprint">kubectl</code> steps will apply to any Kubernetes cluster.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To complete the exercise in this guide, you must locally install Go 1.3+,
Vitess&#39; <code class="prettyprint">vtctlclient</code> tool, and Google Cloud SDK. The
following sections explain how to set these up in your environment.</p>

<h3 id="install-go-1-3">Install Go 1.3+</h3>

<p>You need to install <a href="http://golang.org/doc/install">Go 1.3+</a> to build the
<code class="prettyprint">vtctlclient</code> tool, which issues commands to Vitess.</p>

<p>After installing Go, make sure your <code class="prettyprint">GOPATH</code> environment
variable is set to the root of your workspace. The most common setting
is <code class="prettyprint">GOPATH=$HOME/go</code>, and the value should identify a
directory to which your non-root user has write access.</p>

<p>In addition, make sure that <code class="prettyprint">$GOPATH/bin</code> is included in
your <code class="prettyprint">$PATH</code>. More information about setting up a Go
workspace can be found at
<a href="http://golang.org/doc/code.html#Organization">How to Write Go Code</a>.</p>

<h3 id="build-and-install-vtctlclient">Build and install vtctlclient</h3>

<p>The <code class="prettyprint">vtctlclient</code> tool issues commands to Vitess.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>go get github.com/youtube/vitess/go/cmd/vtctlclient
</code></pre></div>
<p>This command downloads and builds the Vitess source code at:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$GOPATH</span>/src/github.com/youtube/vitess/
</code></pre></div>
<p>It also copies the built <code class="prettyprint">vtctlclient</code> binary into <code class="prettyprint">$GOPATH/bin</code>.</p>

<h3 id="set-up-google-compute-engine-container-engine-and-cloud-tools">Set up Google Compute Engine, Container Engine, and Cloud tools</h3>

<p><strong>Note:</strong> If you are running Kubernetes elsewhere, skip to
<a href="#locate-kubectl">Locate kubectl</a>.</p>

<p>To run Vitess on Kubernetes using Google Compute Engine (GCE),
you must have a GCE account with billing enabled. The instructions
below explain how to enable billing and how to associate a billing
account with a project in the Google Developers Console.</p>

<ol>
<li><p>Log in to the Google Developers Console to <a href="https://console.developers.google.com/billing">enable billing</a>.</p>

<ol>
<li> Click the <strong>Billing</strong> pane if you are not there already.</li>
<li> Click <strong>New billing account</strong>.</li>
<li> Assign a name to the billing account -- e.g. &quot;Vitess on
Kubernetes.&quot; Then click <strong>Continue</strong>. You can sign up
for the <a href="https://cloud.google.com/free-trial/">free trial</a>
to avoid any charges.</li>
</ol></li>
<li><p>Create a project in the Google Developers Console that uses
your billing account:</p>

<ol>
<li> In the Google Developers Console, click the <strong>Projects</strong> pane.</li>
<li> Click the Create Project button.</li>
<li> Assign a name to your project. Then click the <strong>Create</strong> button.
Your project should be created and associated with your
billing account. (If you have multiple billing accounts,
confirm that the project is associated with the correct account.)</li>
<li> After creating your project, click <strong>APIs &amp; auth</strong> in the left menu.</li>
<li> Click <strong>APIs</strong>.</li>
<li> Find <strong>Google Compute Engine</strong> and <strong>Google Container Engine API</strong>.
(Both should be listed under &quot;Google Cloud APIs&quot;.)
For each, click on it, then click the <strong>&quot;Enable API&quot;</strong> button.</li>
</ol></li>
<li><p>Follow the <a href="https://cloud.google.com/sdk/#Quick_Start">Google Cloud SDK quickstart instructions</a> to set up
and test the Google Cloud SDK. You will also set your default project
ID while completing the quickstart.</p>

<p><strong>Note:</strong> If you skip the quickstart guide because you&#39;ve previously set up
the Google Cloud SDK, just make sure to set a default project ID by running
the following command. Replace <code class="prettyprint">PROJECT</code> with the project ID assigned to
your <a href="https://console.developers.google.com/">Google Developers Console</a>
project. You can <a href="https://cloud.google.com/compute/docs/projects#projectids">find the ID</a>
by navigating to the <strong>Overview</strong> page for the project in the Console.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud config <span class="nb">set </span>project PROJECT
</code></pre></div></li>
<li><p>Enable or update beta features in the <code class="prettyprint">gcloud</code> tool, and install
the <code class="prettyprint">kubectl</code> tool:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud components update beta kubectl
</code></pre></div></li>
</ol>

<h3 id="locate-kubectl">Locate kubectl</h3>

<p>Check if <code class="prettyprint">kubectl</code> is on your <code class="prettyprint">PATH</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>which kubectl
<span class="c">### example output:</span>
<span class="c"># ~/google-cloud-sdk/bin/kubectl</span>
</code></pre></div>
<p>If <code class="prettyprint">kubectl</code> isn&#39;t on your <code class="prettyprint">PATH</code>, you can tell our scripts where
to find it by setting the <code class="prettyprint">KUBECTL</code> environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECTL</span><span class="o">=</span>/example/path/to/google-cloud-sdk/bin/kubectl
</code></pre></div>
<h2 id="start-a-container-engine-cluster">Start a Container Engine cluster</h2>

<p><strong>Note:</strong> If you are running Kubernetes elsewhere, skip to
<a href="#start-a-vitess-cluster">Start a Vitess cluster</a>.</p>

<ol>
<li><p>Set the <a href="https://cloud.google.com/compute/docs/zones#overview">zone</a>
that your installation will use:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud config <span class="nb">set </span>compute/zone us-central1-b
</code></pre></div></li>
<li><p>Create a Container Engine cluster:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud beta container clusters create example --machine-type n1-standard-4 --num-nodes 5
<span class="c">### example output:</span>
<span class="c"># Creating cluster example...done.</span>
<span class="c"># Created [https://container.googleapis.com/v1/projects/vitess/zones/us-central1-b/clusters/example].</span>
<span class="c"># kubeconfig entry generated for example.</span>
</code></pre></div></li>
<li><p>The command&#39;s output includes the IP of the Kubernetes master server:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NAME     ZONE           MASTER_VERSION  MASTER_IP     MACHINE_TYPE   STATUS
example  us-central1-b  1.0.6           1.2.3.4       n1-standard-4  RUNNING
</code></pre></div>
<ol>
<li><p>Open /ui on the MASTER_IP in a browser over <em>HTTPS</em>
(e.g. <code class="prettyprint">https://1.2.3.4/ui</code>) to see the Kubernetes
dashboard, where you can monitor nodes, services, pods, etc.</p>

<p><strong>Note:</strong> Your browser will likely complain that the HTTPS certificate
is invalid. This is normal, since the Kubernetes master uses a test
certificate by default. Follow your browser&#39;s instructions to enter
advanced settings and allow you to proceed to the site.</p></li>
<li><p>You should be prompted to enter a username and password to
access the requested page. You can find the randomly-generated password
with <code class="prettyprint">kubectl config view</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl config view
<span class="c">### example output:</span>
<span class="c"># apiVersion: v1</span>
<span class="c"># clusters:</span>
<span class="c"># - cluster:</span>
<span class="c">#     server: https://1.2.3.4</span>
<span class="c"># ...</span>
<span class="c"># users:</span>
<span class="c"># - name: gke_project_us-central1-b_example</span>
<span class="c">#   user:</span>
<span class="c">#     password: gr8j0Rb11</span>
<span class="c">#     username: admin</span>
</code></pre></div></li>
</ol></li>
</ol>

<h2 id="start-a-vitess-cluster">Start a Vitess cluster</h2>

<ol>
<li><p><strong>Navigate to your local Vitess source code</strong></p>

<p>This directory would have been created when you installed
<code class="prettyprint">vtctlclient</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/youtube/vitess
</code></pre></div></li>
<li><p><strong>Start an etcd cluster</strong></p>

<p>The Vitess <a href="http://vitess.io/overview/concepts.html#topology-service">topology service</a>
stores coordination data for all the servers in a Vitess cluster.
It can store this data in one of several consistent storage systems.
In this example, we&#39;ll use <a href="https://github.com/coreos/etcd">etcd</a>.
Note that we need our own etcd clusters, separate from the one used by
Kubernetes itself.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess<span class="nv">$ </span><span class="nb">cd </span>examples/kubernetes
vitess/examples/kubernetes<span class="nv">$ </span>./etcd-up.sh
<span class="c">### example output:</span>
<span class="c"># Generating discovery token for global cell...</span>
<span class="c"># Creating etcd service for global cell...</span>
<span class="c"># services/etcd-global</span>
<span class="c"># Creating etcd replicationcontroller for global cell...</span>
<span class="c"># replicationcontrollers/etcd-global</span>
<span class="c"># ...</span>
</code></pre></div>
<p>This command creates two clusters. One is for the
<a href="http://vitess.io/doc/TopologyService/#global-vs-local">global cell</a>,
and the other is for a
<a href="http://vitess.io/overview/concepts.html#cell-data-center">local cell</a>
called <em>test</em>. You can check the status of the
<a href="http://kubernetes.io/v1.0/docs/user-guide/pods.html">pods</a>
in the cluster by running:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl get pods
<span class="c">### example output:</span>
<span class="c"># NAME                READY     STATUS    RESTARTS   AGE</span>
<span class="c"># etcd-global-8oxzm   1/1       Running   0          1m</span>
<span class="c"># etcd-global-hcxl6   1/1       Running   0          1m</span>
<span class="c"># etcd-global-xupzu   1/1       Running   0          1m</span>
<span class="c"># etcd-test-e2y6o     1/1       Running   0          1m</span>
<span class="c"># etcd-test-m6wse     1/1       Running   0          1m</span>
<span class="c"># etcd-test-qajdj     1/1       Running   0          1m</span>
</code></pre></div>
<p>It may take a while for each Kubernetes node to download the
Docker images the first time it needs them. While the images
are downloading, the pod status will be Pending.</p>

<p><strong>Note:</strong> In this example, each script that has a name ending in
<code class="prettyprint">-up.sh</code> also has a corresponding <code class="prettyprint">-down.sh</code>
script, which can be used to stop certain components of the
Vitess cluster without bringing down the whole cluster. For
example, to tear down the <code class="prettyprint">etcd</code> deployment, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./etcd-down.sh
</code></pre></div></li>
<li><p><strong>Start vtctld</strong></p>

<p>The <code class="prettyprint">vtctld</code> server provides a web interface to inspect the state of the
Vitess cluster. It also accepts RPC commands from <code class="prettyprint">vtctlclient</code> to modify
the cluster.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vtctld-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating vtctld service...</span>
<span class="c"># services/vtctld</span>
<span class="c"># Creating vtctld pod...</span>
<span class="c"># pods/vtctld</span>
<span class="c">#</span>
<span class="c"># vtctld address: http://2.3.4.5:30000</span>
</code></pre></div>
<p>To let you access vtctld from outside Kubernetes, the
<code class="prettyprint">vtctld</code> service is created with the <code class="prettyprint">type: NodePort</code>
option. This creates an <a href="http://kubernetes.io/v1.0/docs/user-guide/services.html#external-services">external service</a>
by exposing a port on each node that forwards to the vtctld service.</p>

<p>The <strong>vtctld address</strong> printed by <code class="prettyprint">vtctld-up.sh</code> is thus the external IP
of one of the nodes, combined with the <code class="prettyprint">nodePort</code> assigned for vtctld.</p></li>
<li><p><strong>Access vtctld</strong></p>

<p>To access the <code class="prettyprint">vtctld</code> service from outside
Kubernetes, you need to open port <code class="prettyprint">30000</code> in your platform&#39;s firewall.
(If you don&#39;t complete this step, the only way to issue commands
to <code class="prettyprint">vtctld</code> would be to SSH into a Kubernetes node
and install and run <code class="prettyprint">vtctlclient</code> there.)</p>

<p>On Compute Engine, you can open the port like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud compute firewall-rules create vtctld --allow tcp:30000
</code></pre></div>
<p>You can then access the vtctld web interface at the address printed
by <code class="prettyprint">vtctld-up.sh</code> above. In this example, the web UI would be at
<code class="prettyprint">http://2.3.4.5:30000</code>.</p></li>
<li><p><strong>Use <code class="prettyprint">vtctlclient</code> to call <code class="prettyprint">vtctld</code></strong></p>

<p>You can now run <code class="prettyprint">vtctlclient</code> locally to issue commands
to the <code class="prettyprint">vtctld</code> service on your Kubernetes cluster.</p>

<p>When you call <code class="prettyprint">vtctlclient</code>, the command requires
the IP address and port for your <code class="prettyprint">vtctld</code> service.
To avoid having to enter that for each command, you can use the
provided <code class="prettyprint">kvtctl.sh</code> script, which uses <code class="prettyprint">kubectl</code> to discover the
proper address.</p>

<p>Now, running <code class="prettyprint">kvtctl.sh help</code> will test your connection to
<code class="prettyprint">vtctld</code> and also list the <code class="prettyprint">vtctlclient</code>
commands that you can use to administer the Vitess cluster.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh <span class="nb">help</span>
<span class="c">### example output:</span>
<span class="c"># Available commands:</span>
<span class="c">#</span>
<span class="c"># Tablets:</span>
<span class="c">#   InitTablet ...</span>
<span class="c"># ...</span>
</code></pre></div>
<p>You can also use the <code class="prettyprint">help</code> command to get more details about each command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh <span class="nb">help </span>InitTablet
</code></pre></div>
<p>See the <a href="http://vitess.io/reference/vtctl.html">vtctl reference</a> for a
web-formatted version of the <code class="prettyprint">vtctl help</code> output.</p></li>
<li><p><strong>Start vttablets</strong></p>

<p>A Vitess <a href="http://vitess.io/overview/concepts.html#tablet">tablet</a> is the
unit of scaling for the database. A tablet consists of the
<code class="prettyprint">vttablet</code> and <code class="prettyprint">mysqld</code> processes, running on the same
host. We enforce this coupling in Kubernetes by putting the respective
containers for vttablet and mysqld inside a single
<a href="http://kubernetes.io/v1.0/docs/user-guide/pods.html">pod</a>.</p>

<p>Run the following script to launch the vttablet pods, which also include
mysqld:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vttablet-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating test_keyspace.shard-0 pods in cell test...</span>
<span class="c"># Creating pod for tablet test-0000000100...</span>
<span class="c"># pods/vttablet-100</span>
<span class="c"># Creating pod for tablet test-0000000101...</span>
<span class="c"># pods/vttablet-101</span>
<span class="c"># Creating pod for tablet test-0000000102...</span>
<span class="c"># pods/vttablet-102</span>
<span class="c"># Creating pod for tablet test-0000000103...</span>
<span class="c"># pods/vttablet-103</span>
<span class="c"># Creating pod for tablet test-0000000104...</span>
<span class="c"># pods/vttablet-104</span>
</code></pre></div>
<p>In the vtctld web UI, you should soon see a keyspace named <code class="prettyprint">test_keyspace</code>
with a single shard named <code class="prettyprint">0</code>. Click on the shard name to see the list of
tablets. When all 5 tablets show up on the shard status page, you&#39;re ready
to continue.</p>

<p>It can take some time for the tablets to come up for the first time if a pod
was scheduled on a node that hasn&#39;t downloaded the <a href="https://hub.docker.com/u/vitess/">Vitess Docker image</a> yet. You can also check the status of the
tablets from the command line using <code class="prettyprint">kvtctl.sh</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ListAllTablets <span class="nb">test</span>
<span class="c">### example output:</span>
<span class="c"># test-0000000100 test_keyspace 0 replica 10.64.1.6:15002 10.64.1.6:3306 []</span>
<span class="c"># test-0000000101 test_keyspace 0 replica 10.64.2.5:15002 10.64.2.5:3306 []</span>
<span class="c"># test-0000000102 test_keyspace 0 replica 10.64.0.7:15002 10.64.0.7:3306 []</span>
<span class="c"># test-0000000103 test_keyspace 0 rdonly 10.64.1.7:15002 10.64.1.7:3306 []</span>
<span class="c"># test-0000000104 test_keyspace 0 rdonly 10.64.2.6:15002 10.64.2.6:3306 []</span>
</code></pre></div>
<p>Note that of the 5 tablets, the first 3 were assigned to be
<strong>replica</strong> type (for serving live web traffic), while the last 2
were assigned to be <strong>rdonly</strong> type (for offline processing).
These allocations can be configured in the <code class="prettyprint">vttablet-up.sh</code> script.
See the <a href="http://vitess.io/overview/concepts.html#tablet">tablet</a>
reference for more about the available tablet types.</p>

<p>By bringing up tablets in a previously empty
<a href="http://vitess.io/overview/concepts.html#keyspace">keyspace</a>,
you have effectively just created a new
<a href="http://vitess.io/overview/concepts.html#shard">shard</a>.
To complete the initialization of the keyspace for the new
shard, call the <code class="prettyprint">kvtctl.sh RebuildKeyspaceGraph</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh RebuildKeyspaceGraph test_keyspace
</code></pre></div>
<p><strong>Note:</strong> Many <code class="prettyprint">vtctlclient</code> commands produce no output on success.</p>

<p><strong><em>Status pages for vttablets</em></strong></p>

<p>Each <code class="prettyprint">vttablet</code> serves a set of HTML status pages on its primary port.
The <code class="prettyprint">vtctld</code> interface provides a <strong>STATUS</strong> link for each tablet, but the
links are actually to internal, per-pod IPs that can only be accessed from
within Kubernetes.</p>

<p>As a workaround, you can access tablet status pages through the
<a href="http://kubernetes.io/v1.0/docs/user-guide/accessing-the-cluster.html#accessing-services-running-on-the-cluster">apiserver proxy</a>,
provided by the Kubernetes master. For example, to see the status
page for the tablet with ID 100 (recall that our Kubernetes master is
on public IP 1.2.3.4), you could navigate to:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://1.2.3.4/api/v1/proxy/namespaces/default/pods/vttablet-100:15002/debug/status
</code></pre></div>
<p>In the future, we plan to have vtctld directly link through this proxy from
the <strong>STATUS</strong> link.</p>

<p><strong><em>Direct connection to mysqld</em></strong></p>

<p>Since the <code class="prettyprint">mysqld</code> within the <code class="prettyprint">vttablet</code> pod is only meant to be accessed
via vttablet, our default bootstrap settings only allow connections from
localhost.</p>

<p>If you want to check or manipulate the underlying mysqld, you can issue
simple queries or commands through <code class="prettyprint">vtctlclient</code> like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Send a query to tablet 100 in cell &#39;test&#39;.</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000100 <span class="s2">&quot;SELECT VERSION()&quot;</span>
<span class="c">### example output:</span>
<span class="c"># {</span>
<span class="c">#   &quot;Fields&quot;: null,</span>
<span class="c">#   &quot;RowsAffected&quot;: 1,</span>
<span class="c">#   &quot;InsertId&quot;: 0,</span>
<span class="c">#   &quot;Rows&quot;: [</span>
<span class="c">#     [</span>
<span class="c">#       &quot;10.0.20-MariaDB-1~wheezy-log&quot;</span>
<span class="c">#     ]</span>
<span class="c">#   ],</span>
<span class="c">#   &quot;Err&quot;: null</span>
<span class="c"># }</span>
</code></pre></div>
<p>If you need a truly direct connection to mysqld for bulk operations,
you can SSH to the Kubernetes node on which the pod is running.
Then use
<a href="https://docs.docker.com/reference/commandline/exec/">docker exec</a>
to launch a bash shell inside the mysql container, and connect with the
<code class="prettyprint">mysql</code> command-line client:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># For example, to connect to the mysql container within the vttablet-100 pod:</span>
<span class="nv">$ </span>kubectl get pods -o wide <span class="p">|</span> grep vttablet-100
<span class="c">### example output:</span>
<span class="c"># vttablet-100   2/2   Running   0   17m   gke-example-960176fd-node-3mkd</span>
<span class="nv">$ </span>gcloud compute ssh gke-example-960176fd-node-3mkd
gke-example-960176fd-node-3mkd:~<span class="nv">$ </span>sudo docker ps <span class="p">|</span> grep vttablet-100 <span class="p">|</span> grep k8s_mysql
<span class="c">### example output:</span>
<span class="c"># ef40b4ff08fa   vitess/lite:latest [...]  k8s_mysql.16e2a810_vttablet-100[...]</span>
k8s-example-3c0115e4-node-x6jc:~<span class="nv">$ </span>sudo docker <span class="nb">exec</span> -ti ef40b4ff08fa bash
<span class="c"># Now you&#39;re in a shell inside the mysql container.</span>
<span class="c"># We need to tell the mysql client the username and socket file to use.</span>
vttablet-100:/# <span class="nv">TERM</span><span class="o">=</span>ansi mysql -u vt_dba -S /vt/vtdataroot/vt_0000000100/mysql.sock
</code></pre></div>
<p><strong>Note:</strong> <code class="prettyprint">gcloud compute ssh</code> uses an SSH key to login to the Kubernetes
node. If you haven&#39;t done yet, <code class="prettyprint">gcloud</code> will create an SSH key for
you and ask you for a passphrase for the SSH key.
For subsequent logins via SSH, it may prompt you for the passphrase again.</p></li>
<li><p><strong>Elect a master vttablet</strong></p>

<p>The tablets all start as slaves by default. In this step, you
designate one of the tablets to be the master. Vitess
automatically connects the other slaves&#39; mysqld instances
so that they start replicating from the master&#39;s mysqld.</p>

<p>Since this is the first time the shard has been started,
the tablets are not already doing any replication, and the
tablet types are all replica or rdonly. As a
result, the following command uses the <code class="prettyprint">-force</code>
flag when calling the <code class="prettyprint">InitShardMaster</code> command
to be able to promote one instance to master.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh InitShardMaster -force test_keyspace/0 <span class="nb">test</span>-0000000100
<span class="c">### example output:</span>
<span class="c"># master-elect tablet test-0000000100 is not the shard master, proceeding anyway as -force was used</span>
<span class="c"># master-elect tablet test-0000000100 is not a master in the shard, proceeding anyway as -force was used</span>
</code></pre></div>
<p><strong>Note:</strong> If you do not include the <code class="prettyprint">-force</code> flag
here, the command will first check to ensure the provided
tablet is the only tablet of type master in the shard.
However, since none of the slaves are masters, and we&#39;re not
replicating at all, that check would fail and the command
would fail as well.</p>

<p>After running this command, go back to the <strong>Shard Status</strong> page
in the <code class="prettyprint">vtctld</code> web interface. When you refresh the
page, you should see that one tablet is the master
and the others are replica or rdonly.</p>

<p>You can also run this command on the command line to see the
same data:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ListAllTablets <span class="nb">test</span>
<span class="c">### example output:</span>
<span class="c"># test-0000000100 test_keyspace 0 master 10.64.1.6:15002 10.64.1.6:3306 []</span>
<span class="c"># test-0000000101 test_keyspace 0 replica 10.64.2.5:15002 10.64.2.5:3306 []</span>
<span class="c"># test-0000000102 test_keyspace 0 replica 10.64.0.7:15002 10.64.0.7:3306 []</span>
<span class="c"># test-0000000103 test_keyspace 0 rdonly 10.64.1.7:15002 10.64.1.7:3306 []</span>
<span class="c"># test-0000000104 test_keyspace 0 rdonly 10.64.2.6:15002 10.64.2.6:3306 []</span>
</code></pre></div></li>
<li><p><strong>Create a table</strong></p>

<p>The <code class="prettyprint">vtctlclient</code> tool can be used to apply the database schema
across all tablets in a keyspace. The following command creates
the table defined in the <code class="prettyprint">create_test_table.sql</code> file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Make sure to run this from the examples/kubernetes dir, so it finds the file.</span>
vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ApplySchema -sql <span class="s2">&quot;$(cat create_test_table.sql)&quot;</span> test_keyspace
</code></pre></div>
<p>The SQL to create the table is shown below:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">CREATE TABLE messages (
  page BIGINT(20) UNSIGNED,
  time_created_ns BIGINT(20) UNSIGNED,
  keyspace_id BIGINT(20) UNSIGNED,
  message VARCHAR(10000),
  PRIMARY KEY (page, time_created_ns)
) ENGINE=InnoDB
</code></pre></div>
<p>You can run this command to confirm that the schema was created
properly on a given tablet, where <code class="prettyprint">test-0000000100</code>
is a tablet alias as shown by the <code class="prettyprint">ListAllTablets</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh GetSchema <span class="nb">test</span>-0000000100
<span class="c">### example output:</span>
<span class="c"># {</span>
<span class="c">#   &quot;DatabaseSchema&quot;: &quot;CREATE DATABASE `` /*!40100 DEFAULT CHARACTER SET utf8 */&quot;,</span>
<span class="c">#   &quot;TableDefinitions&quot;: [</span>
<span class="c">#     {</span>
<span class="c">#       &quot;Name&quot;: &quot;messages&quot;,</span>
<span class="c">#       &quot;Schema&quot;: &quot;CREATE TABLE `messages` (\n  `page` bigint(20) unsigned NOT NULL DEFAULT &#39;0&#39;,\n  `time_created_ns` bigint(20) unsigned NOT NULL DEFAULT &#39;0&#39;,\n  `keyspace_id` bigint(20) unsigned DEFAULT NULL,\n  `message` varchar(10000) DEFAULT NULL,\n  PRIMARY KEY (`page`,`time_created_ns`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8&quot;,</span>
<span class="c">#       &quot;Columns&quot;: [</span>
<span class="c">#         &quot;page&quot;,</span>
<span class="c">#         &quot;time_created_ns&quot;,</span>
<span class="c">#         &quot;keyspace_id&quot;,</span>
<span class="c">#         &quot;message&quot;</span>
<span class="c">#       ],</span>
<span class="c"># ...</span>
</code></pre></div></li>
<li><p><strong>Start <code class="prettyprint">vtgate</code></strong></p>

<p>Vitess uses <a href="http://vitess.io/overview/#vtgate">vtgate</a> to route each client
query to the correct <code class="prettyprint">vttablet</code>. In Kubernetes, a <code class="prettyprint">vtgate</code> service
distributes connections to a pool of <code class="prettyprint">vtgate</code> pods. The pods are curated by
a <a href="http://kubernetes.io/v1.0/docs/user-guide/replication-controller.html">replication controller</a>.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vtgate-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating vtgate service...</span>
<span class="c"># services/vtgate</span>
<span class="c"># Creating vtgate replicationcontroller...</span>
<span class="c"># replicationcontrollers/vtgate</span>
</code></pre></div></li>
</ol>

<h2 id="test-your-cluster-with-a-client-app">Test your cluster with a client app</h2>

<p>The GuestBook app in the example is ported from the
<a href="https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook-go">Kubernetes GuestBook example</a>.
The server-side code has been rewritten in Python to use Vitess as the storage
engine. The client-side code (HTML/JavaScript) has been modified to support
multiple Guestbook pages, which will be useful to demonstrate Vitess sharding in
a later guide.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./guestbook-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating guestbook service...</span>
<span class="c"># services/guestbook</span>
<span class="c"># Creating guestbook replicationcontroller...</span>
<span class="c"># replicationcontrollers/guestbook</span>
</code></pre></div>
<p>As with the <code class="prettyprint">vtctld</code> service, to access the GuestBook
app from outside Kubernetes, we need to set the <code class="prettyprint">type</code> field in the
service definition to something that generates an external service.</p>

<p>In this case, since this is a user-facing frontend, we use
<code class="prettyprint">type: LoadBalancer</code>, which tells Kubernetes to create a public
<a href="http://kubernetes.io/v1.0/docs/user-guide/services.html#type-loadbalancer">load balancer</a>
using the API for whatever platform your Kubernetes cluster is in.</p>

<p>As before, you also need to allow access through your platform&#39;s firewall:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># For example, to open port 80 in the GCE firewall:</span>
<span class="nv">$ </span>gcloud compute firewall-rules create guestbook --allow tcp:80
</code></pre></div>
<p>Then, get the external IP of the load balancer for the GuestBook service:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl get -o yaml service guestbook
<span class="c">### example output:</span>
<span class="c"># apiVersion: v1</span>
<span class="c"># kind: Service</span>
<span class="c"># ...</span>
<span class="c"># status:</span>
<span class="c">#   loadBalancer:</span>
<span class="c">#     ingress:</span>
<span class="c">#     - ip: 3.4.5.6</span>
</code></pre></div>
<p>If the status shows <code class="prettyprint">loadBalancer: {}</code>, it may just need more time.</p>

<p>Once the pods are running, the GuestBook app should be accessible
from the load balancer&#39;s external IP. In the example above, it would be at
<code class="prettyprint">http://3.4.5.6</code>.</p>

<p>You can see Vitess&#39; replication capabilities by opening the app in
multiple browser windows, with the same Guestbook page number.
Each new entry is committed to the master database.
In the meantime, JavaScript on the page continuously polls
the app server to retrieve a list of GuestBook entries. The app serves
read-only requests by querying Vitess in &#39;replica&#39; mode, confirming
that replication is working.</p>

<p>You can also inspect the data stored by the app:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./kvtctl.sh ExecuteFetchAsDba <span class="nb">test</span>-0000000100 <span class="s2">&quot;SELECT * FROM messages&quot;</span>
<span class="c">### example output:</span>
<span class="c"># {</span>
<span class="c">#   &quot;Fields&quot;: [],</span>
<span class="c">#   &quot;RowsAffected&quot;: 3,</span>
<span class="c">#   &quot;InsertId&quot;: 0,</span>
<span class="c">#   &quot;Rows&quot;: [</span>
<span class="c">#     [</span>
<span class="c">#       &quot;42&quot;,</span>
<span class="c">#       &quot;1435441767473414912&quot;,</span>
<span class="c">#       &quot;9080723075667090943&quot;,</span>
<span class="c">#       &quot;First!&quot;</span>
<span class="c">#     ],</span>
<span class="c">#     [</span>
<span class="c">#       &quot;42&quot;,</span>
<span class="c">#       &quot;1435441772740816128&quot;,</span>
<span class="c">#       &quot;9080723075667090943&quot;,</span>
<span class="c">#       &quot;Message 2&quot;</span>
<span class="c">#     ],</span>
<span class="c">#     [</span>
<span class="c">#       &quot;42&quot;,</span>
<span class="c">#       &quot;1435441778454107904&quot;,</span>
<span class="c">#       &quot;9080723075667090943&quot;,</span>
<span class="c">#       &quot;Message 3&quot;</span>
<span class="c">#     ]</span>
<span class="c">#   ],</span>
<span class="c">#   &quot;Err&quot;: null</span>
<span class="c"># }</span>
</code></pre></div>
<p>The <a href="https://github.com/youtube/vitess/tree/master/examples/kubernetes/guestbook">GuestBook source code</a>
provides more detail about how the app server interacts with Vitess.</p>

<h2 id="try-vitess-resharding">Try Vitess resharding</h2>

<p>Now that you have a full Vitess stack running, you may want to go on to the
<a href="http://vitess.io/user-guide/sharding-kubernetes.html">Sharding in Kubernetes</a>
guide to try out
<a href="http://vitess.io/user-guide/sharding.html#resharding">dynamic resharding</a>.</p>

<p>If so, you can skip the tear-down since the sharding guide picks up right here.
If not, continue to the clean-up steps below.</p>

<h2 id="tear-down-and-clean-up">Tear down and clean up</h2>

<p>Before stopping the Container Engine cluster, you should tear down the Vitess
services. Kubernetes will then take care of cleaning up any entities it created
for those services, like external load balancers.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./guestbook-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./vtgate-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./vttablet-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./vtctld-down.sh
vitess/examples/kubernetes<span class="nv">$ </span>./etcd-down.sh
</code></pre></div>
<p>Then tear down the Container Engine cluster itself, which will stop the virtual
machines running on Compute Engine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud beta container clusters delete example
</code></pre></div>
<p>It&#39;s also a good idea to remove the firewall rules you created, unless you plan
to use them again soon:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud compute firewall-rules delete vtctld guestbook
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="server-logs">Server Logs</h3>

<p>If a pod enters the <code class="prettyprint">Running</code> state, but the server
doesn&#39;t respond as expected, use the <code class="prettyprint">kubectl logs</code>
command to check the pod output:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># show logs for container &#39;vttablet&#39; within pod &#39;vttablet-100&#39;</span>
<span class="nv">$ </span>kubectl logs vttablet-100 vttablet

<span class="c"># show logs for container &#39;mysql&#39; within pod &#39;vttablet-100&#39;</span>
<span class="nv">$ </span>kubectl logs vttablet-100 mysql
</code></pre></div>
<p>Post the logs somewhere and send a link to the <a href="https://groups.google.com/forum/#!forum/vitess">Vitess
mailing list</a>
to get more help.</p>

<h3 id="root-certificates">Root Certificates</h3>

<p>If you see in the logs a message like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">x509: failed to load system roots and no roots provided
</code></pre></div>
<p>It usually means that your Kubernetes nodes are running a host OS
that puts root certificates in a different place than our configuration
expects by default (for example, Fedora). See the comments in the
<a href="https://github.com/youtube/vitess/blob/master/examples/kubernetes/etcd-controller-template.yaml">etcd controller template</a>
for examples of how to set the right location for your host OS.</p>

      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

  </body>
</html>
