<!DOCTYPE html>
<html lang="en-US">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width" />
      <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Vitess - Running Vitess on Kubernetes</title>
<meta name="description" content="Vitess runs best in a containerized environment like Kubernetes, which manages a cluster of Linux containers as a single system.">

<link rel="canonical" href="http://vitess.io/getting-started/">

<!-- Add to homescreen for Chrome on Android -->
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="196x196" href="/images/touch/chrome-touch-icon-196x196.png">

<!-- Add to homescreen for Safari on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Vitess">

<!-- Tile icon for Win8 (144x144 + tile color) -->
<meta name="msapplication-TileImage" content="/images/touch/ms-touch-icon-144x144-precomposed.png">
<meta name="msapplication-TileColor" content="#3372DF">

      <link rel="stylesheet" href="/assets/vendor/styles/wsk.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,600,900|Roboto+Condensed:300,300italic,400,700">

      <link rel="stylesheet" href="/css/components.css">
      <link rel="stylesheet" href="/css/responsee.css">
      <!-- CUSTOM STYLE -->
      <link rel="stylesheet" href="/css/template-style.css">
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
      <script type="text/javascript" src="/assets/scripts/jquery-1.8.3.min.js"></script>
      <script type="text/javascript" src="/assets/scripts/jquery-ui.min.js"></script>    
      <script type="text/javascript" src="/assets/scripts/modernizr.js"></script>
      <script type="text/javascript" src="/assets/scripts/responsee.js"></script>
      <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
   </head>
   <body class="size-1140">
      <header id="app-bar" class="app-bar promote-layer">
         <div class="line">
            <div class="app-bar-container">
               <button id="menu" class="menu" title="Menu"></button>
               <h1 class="logo"><a href="/">Vitess</a></h1>
               <section class="app-bar-actions">
                  <a href="#"><i class="icon icon-chevron-up"></i> Top</a>
               </section>
            </div>
            <div class="navdrawer">
              <nav id="nav" class="navdrawer-container promote-layer">
                <h4>Navigation</h4>
                
<ul>
  
    <li >
      <a href="//"></a>
    </li>
  
    <li >
      <a href="/overview/">Overview</a>
    </li>
  
    <li >
      <a href="/getting-started/">Getting Started</a>
    </li>
  
  <li><a href="https://github.com/youtube/vitess">GitHub</a></li>
</ul>

              </nav>
            </div>
         </div>
      </header>
      <!-- ASIDE NAV AND CONTENT -->
      <div class="line">
         <div class="box  margin-bottom">
            <div class="margin">
               <!-- ASIDE NAV 2 -->
               <nav class="scrolling-nav" style="margin:0">
               <aside class="s-12">
                  <div class="aside-nav">
                     <div class="aside-nav-header">Overview</div>
                     <ul>
                        <li><a href="/overview/">What is Vitess</a></li>
                        <li><a href="/overview/concepts.html">Key Concepts</a></li>
                     </ul>
                     <div class="aside-nav-header">Getting Started</div>
                     <ul>
                        <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
                        <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
                     </ul>
                     <div class="aside-nav-header">User Guide</div>
                     <ul>
                        <li><a href="/user-guide/sharding.html">Sharding</a>
                          <ul>
                            <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                          </ul>
                        </li>
<!--
                        <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
                        <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
                        <li><a href="/user-guide/storage.html">Storage</a></li>
                        <li><a href="/user-guide/api.html">Using the API</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Architecture</div>
                     <ul>
                        <li><a href="/architecture/life-of-a-query.html">Life of a Query</a></li>
                        <li><a href="/architecture/topology-service.html">Topology Service</a></li>
                     </ul>

                     <div class="aside-nav-header">Maintenance</div>
                     <ul>
                        <li><a href="/maintenance/monitoring.html">Monitoring</a></li>
                        <li><a href="/maintenance/testing.html">Testing</a></li>
                     </ul>
-->
                     <div class="aside-nav-header">Reference</div>
                     <ul>
                        <li><a href="/reference/vtctl.html">vtctl Reference</a></li>
<!--
                        <li><a href="/reference/api.html">API Reference</a></li>
                        <li><a href="/reference/client-libraries/">Client Libraries</a></li>
-->
                     </ul>
<!--
                     <div class="aside-nav-header">Other Resources</div>
                     <ul>
                        <li><a href="/resources/presentations.html">Presentations</a></li>
                        <li class="last"><a href="/resources/roadmap.html">Roadmap</a></li>
                     </ul>
                  </div>
-->
               </aside>
               </nav>
               <!-- CONTENT -->
               <section class="s-12 l-9">
                 <main class="clear">

  <header class="page-header container">
    <h2 class="xxlarge text-divider">Running Vitess on Kubernetes</h2>
    
      <p class="page-header__excerpt g-wide--push-1 g-wide--pull-1" style="padding-bottom: 32px;">
        Vitess runs best in a containerized environment like Kubernetes, which manages a cluster of Linux containers as a single system.
      </p>
    
  </header>

  <div class="container">
    <p>This page explains how to run Vitess on <a href="http://kubernetes.io">Kubernetes</a>.
It also gives the steps to start a Kubernetes cluster with
<a href="https://cloud.google.com/container-engine/">Google Container Engine</a>.</p>

<p>If you already have Kubernetes v0.18+ running in one of the other
<a href="http://kubernetes.io/gettingstarted/">supported platforms</a>,
you can skip the <code>gcloud</code> steps.
The <code>kubectl</code> steps will apply to any Kubernetes cluster.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To complete the exercise in this guide, you must locally install Go 1.3+,
Vitess&#39; <code>vtctlclient</code> tool, and Google Cloud SDK. The
following sections explain how to set these up in your environment.</p>

<h3 id="install-go-1.3+">Install Go 1.3+</h3>

<p>You need to install <a href="http://golang.org/doc/install">Go 1.3+</a> to build the
<code>vtctlclient</code> tool, which issues commands to Vitess.</p>

<p>After installing Go, make sure your <code>GOPATH</code> environment
variable is set to the root of your workspace. The most common setting
is <code>GOPATH=$HOME/go</code>, and the value should identify a
directory to which your non-root user has write access.</p>

<p>In addition, make sure that <code>$GOPATH/bin</code> is included in
your <code>$PATH</code>. More information about setting up a Go
workspace can be found at
<a href="http://golang.org/doc/code.html#Organization">http://golang.org/doc/code.html#Organization</a>.</p>

<h2 id="build-and-install-vtctlclient">Build and install <code>vtctlclient</code></h2>

<p>The <code>vtctlclient</code> tool issues commands to Vitess.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>go get github.com/youtube/vitess/go/cmd/vtctlclient
</code></pre></div>
<p>This command downloads and builds the Vitess source code at:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$GOPATH</span>/src/github.com/youtube/vitess/
</code></pre></div>
<p>It also copies the built <code>vtctlclient</code> binary into <code>$GOPATH/bin</code>.</p>

<h3 id="set-up-google-compute-engine,-container-engine,-and-cloud-tools">Set up Google Compute Engine, Container Engine, and Cloud tools</h3>

<p>To run Vitess on Kubernetes using Google Compute Engine (GCE),
you must have a GCE account with billing enabled. The instructions
below explain how to enable billing and how to associate a billing
account with a project in the Google Developers Console.</p>

<ol>
<li><p>Log in to the Google Developers Console to <a href="https://console.developers.google.com/billing">enable billing</a>.</p>

<ol>
<li> Click the <strong>Billing</strong> pane if you are not there already.</li>
<li> Click <strong>New billing account</strong></li>
<li> Assign a name to the billing account -- e.g. &quot;Vitess on
Kubernetes.&quot; Then click <strong>Continue</strong>. You can sign up
for the <a href="https://cloud.google.com/free-trial/">free trial</a>
to avoid any charges.</li>
</ol></li>
<li><p>Create a project in the Google Developers Console that uses
your billing account:</p>

<ol>
<li> In the Google Developers Console, click the <strong>Projects</strong> pane.</li>
<li> Click the Create Project button.</li>
<li> Assign a name to your project. Then click the <strong>Create</strong> button.
Your project should be created and associated with your
billing account. (If you have multiple billing accounts,
confirm that the project is associated with the correct account.)</li>
<li> After creating your project, click <strong>APIs &amp; auth</strong> in the left menu.</li>
<li> Click <strong>APIs</strong>.</li>
<li> Find <strong>Google Compute Engine</strong> and <strong>Google Container Engine API</strong>
and click the <strong>OFF</strong> button for each to enable those two APIs.</li>
</ol></li>
<li><p>Follow the <a href="https://cloud.google.com/compute/docs/quickstart#setup">GCE quickstart guide</a> to set up
and test the Google Cloud SDK. You will also set your default project
ID while completing the quickstart. Start with step 2 in the setup
process.</p>

<p><strong>Note:</strong> During the quickstart, you&#39;ll generate an SSH key for
Google Compute Engine, and you will be prompted to enter a
passphrase. You will be prompted for that passphrase several times
when bringing up your Kubernetes cluster later in this guide.</p></li>
</ol>

<h2 id="start-a-kubernetes-cluster">Start a Kubernetes cluster</h2>

<ol>
<li><p>Enable or update alpha features in the <code>gcloud</code> tool, and install
the <code>kubectl</code> tool:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud components update alpha kubectl
</code></pre></div><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Check if kubectl is on your PATH:</span>
<span class="nv">$ </span>which kubectl
<span class="c">### example output:</span>
<span class="c"># ~/google-cloud-sdk/bin/kubectl</span>
</code></pre></div>
<p>If <code>kubectl</code> isn&#39;t on your PATH, you can tell our scripts where
to find it by setting the <code>KUBECTL</code> environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECTL</span><span class="o">=</span>/example/path/to/google-cloud-sdk/bin/kubectl
</code></pre></div></li>
<li><p>If you did not complete the <a href="https://cloud.google.com/compute/docs/quickstart#setup">GCE quickstart guide</a>, set
your default project ID by running the following command.
Replace <code>PROJECT</code> with the project ID assigned to your
<a href="https://console.developers.google.com/">Google Developers Console</a>
project. You can <a href="https://cloud.google.com/compute/docs/overview#projectids">find the ID</a>
by navigating to the <strong>Overview</strong> page for the project
in the Console.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud config <span class="nb">set </span>project PROJECT
</code></pre></div></li>
<li><p>Set the <a href="https://cloud.google.com/compute/docs/zones#overview">zone</a>
that your installation will use:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud config <span class="nb">set </span>compute/zone us-central1-b
</code></pre></div></li>
<li><p>Create a Kubernetes cluster:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud alpha container clusters create example --machine-type n1-standard-1 --num-nodes 3
</code></pre></div></li>
<li><p>While the cluster is starting, you will be prompted several
times for the passphrase you created while setting up Google
Compute Engine.</p></li>
<li><p>The command&#39;s output includes the IP of the Kubernetes master server:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">NAME     ZONE           CLUSTER_API_VERSION  MASTER_IP       MACHINE_TYPE                           NODES  STATUS
example  us-central1-b  0.18.2               1.2.3.4         n1-standard-1, container-vm-v20150505  3      running
</code></pre></div>
<ol>
<li> Open /static/app/ on the MASTER_IP in a browser over HTTPS
(e.g. <code><a href="https://1.2.3.4/static/app/">https://1.2.3.4/static/app/</a></code>) to see the Kubernetes
dashboard, where you can monitor nodes, services, pods, etc.</li>
<li> If you see a <code>ERRCERTAUTHORITY_INVALID</code> error
indicating that the server&#39;s security certificate is not
trusted by your computer&#39;s operating system, click the
<strong>Advanced</strong> link and then the link to proceed to the URL.</li>
<li> You should be prompted to enter a username and password to
access the requested page. Use <code>admin</code> as the username.
The randomly-generated password can be found in the <code>token</code>
field of the kubectl config:</li>
</ol>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl config view
<span class="c">### example output:</span>
<span class="c"># apiVersion: v1</span>
<span class="c"># clusters:</span>
<span class="c"># - cluster:</span>
<span class="c">#     server: https://1.2.3.4</span>
<span class="c"># ...</span>
<span class="c"># users:</span>
<span class="c"># - name: gke_project_us-central1-b_example</span>
<span class="c">#   user:</span>
<span class="c">#     token: randompassword</span>
</code></pre></div></li>
</ol>

<h2 id="start-a-vitess-cluster">Start a Vitess cluster</h2>

<ol>
<li><p><strong>Navigate to your local Vitess source code</strong></p>

<p>This directory would have been created when you installed
<code>vtctlclient</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/youtube/vitess
</code></pre></div></li>
<li><p><strong>Start an etcd cluster:</strong></p>

<p>The Vitess <a href="http://vitess.io/overview/concepts.html#topology-service">topology service</a>
stores coordination data for all the servers in a Vitess cluster.
It can store this data in one of several consistent storage systems.
In this example, we&#39;ll use <a href="https://github.com/coreos/etcd">etcd</a>.
Note that we need our own etcd clusters, separate from the one used by
Kubernetes itself.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">cd </span>examples/kubernetes
vitess/examples/kubernetes<span class="nv">$ </span>./etcd-up.sh
</code></pre></div>
<p><br>This command creates two clusters. One is for the
<a href="http://vitess.io/doc/TopologyService/#global-vs-local">global cell</a>,
and the other is for a
<a href="http://vitess.io/overview/concepts.html#cell-(data-center)">local cell</a>
called <em>test</em>. You can check the status of the
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/pods.md">pods</a>
in the cluster by running:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl get pods
</code></pre></div>
<p><br>It may take a while for each Kubernetes node to download the
Docker images the first time it needs them. While the images
are downloading, the pod status will be Pending.<br><br></p>

<p><strong>Note:</strong> In this example, each script that has a name ending in
<code>-up.sh</code> also has a corresponding <code>-down.sh</code>
script, which can be used to stop certain components of the
Vitess cluster without bringing down the whole cluster. For
example, to tear down the <code>etcd</code> deployment, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./etcd-down.sh
</code></pre></div></li>
<li><p><strong>Start vtctld</strong></p>

<p>The <code>vtctld</code> server provides a web interface to
inspect the state of the Vitess cluster. It also accepts RPC
commands from <code>vtctlclient</code> to modify the cluster.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vtctld-up.sh
</code></pre></div>
<p><br>To let you access vtctld from outside Kubernetes, the
<code>vtctld</code> service is created with the <code>type: NodePort</code>
option. This creates an
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md#external-services">external service</a>
by exposing a port on each node that forwards to the vtctld service.<br><br></p></li>
<li><p><strong>Access vtctld</strong></p>

<p>To access the <code>vtctld</code> service from outside
Kubernetes, you need to open port 30000 in your platform&#39;s firewall.
(If you don&#39;t complete this step, the only way to issue commands
to <code>vtctld</code> would be to SSH into a Kubernetes node
and install and run <code>vtctlclient</code> there.)<br><br></p>

<p>On GCE, you can open the port like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud compute firewall-rules create vtctld --allow tcp:30000
</code></pre></div>
<p><br>Then, get the <code>ExternalIP</code> of any Kubernetes node
(not the master):</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl get -o yaml nodes
<span class="c">### example output:</span>
<span class="c"># - apiVersion: v1beta3</span>
<span class="c">#   kind: Node</span>
<span class="c"># ...</span>
<span class="c">#   status:</span>
<span class="c">#     addresses:</span>
<span class="c">#     - address: 2.3.4.5</span>
<span class="c">#       type: ExternalIP</span>
<span class="c"># ...</span>
</code></pre></div>
<p><br>You can then access the <code>vtctld</code> web interface at port 30000
of the EXTERNAL_IP address returned in the above command.
In this example, the web UI would be at
<code><a href="http://2.3.4.5:30000">http://2.3.4.5:30000</a></code>.</p></li>
<li><p><strong>Use <code>vtctlclient</code> to call <code>vtctld</code></strong></p>

<p>You can now run <code>vtctlclient</code> locally to issue commands
to the <code>vtctld</code> service on your Kubernetes cluster.<br><br></p>

<p>When you call <code>vtctlclient</code>, the command includes
the IP address and port for your <code>vtctld</code> service.
To avoid having to enter that for each command, create an alias
called <code>kvtctl</code> that points to the address from above:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">alias </span><span class="nv">kvtctl</span><span class="o">=</span><span class="s1">&#39;vtctlclient -server 2.3.4.5:30000&#39;</span>
</code></pre></div>
<p><br>Now, running <code>kvtctl help</code> will test your connection to
<code>vtctld</code> and also list the <code>vtctlclient</code>
commands that you can use to administer the Vitess cluster.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Test the connection to vtctld and list available commands</span>
<span class="nv">$ </span>kvtctl <span class="nb">help</span>
<span class="c">### example output:</span>
<span class="c"># Available commands:</span>
<span class="c">#</span>
<span class="c"># Tablets:</span>
<span class="c">#   InitTablet ...</span>
<span class="c"># ...</span>
</code></pre></div><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Get usage for a specific command:</span>
<span class="nv">$ </span>kvtctl <span class="nb">help </span>InitTablet
</code></pre></div>
<p><br>See the <a href="http://vitess.io/reference/vtctl.html">vtctl reference</a> for a
web-formatted version of the <code>vtctl help</code> output.</p></li>
<li><p><strong>Start vttablets</strong></p>

<p>A Vitess <a href="http://vitess.io/overview/concepts.html#tablet">tablet</a> is the
unit of scaling for the database. A tablet consists of the
<code>vttablet</code> and <code>mysqld</code> processes, running on the same
host. We enforce this coupling in Kubernetes by putting the respective
containers for vttablet and mysqld inside a single
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/pods.md">pod</a></p>

<p>Run the following script to launch the vttablet pod, which also includes
mysqld:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vttablet-up.sh
<span class="c">### example output:</span>
<span class="c"># Creating test_keyspace.shard-0 pods in cell test...</span>
<span class="c"># Creating pod for tablet test-0000000100...</span>
<span class="c"># pods/vttablet-100</span>
<span class="c"># Creating pod for tablet test-0000000101...</span>
<span class="c"># pods/vttablet-101</span>
<span class="c"># Creating pod for tablet test-0000000102...</span>
<span class="c"># pods/vttablet-102</span>
</code></pre></div>
<p><br>Wait until you see all 3 tablets listed in the <strong>Topology</strong> summary page
for your <code>vtctld</code> instance
(e.g. <code><a href="http://2.3.4.5:30000/dbtopo">http://2.3.4.5:30000/dbtopo</a></code>).
This can take some time if a pod was scheduled on a node that needs to
download the latest Vitess Docker image. You can also check the status of
the tablets from the command line using <code>kvtctl</code>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kvtctl ListAllTablets <span class="nb">test</span>
<span class="c">### example output:</span>
<span class="c"># test-0000000100 test_keyspace 0 replica 10.64.2.9:15002 10.64.2.9:3306 []</span>
<span class="c"># test-0000000101 test_keyspace 0 replica 10.64.1.12:15002 10.64.1.12:3306 []</span>
<span class="c"># test-0000000102 test_keyspace 0 replica 10.64.2.10:15002 10.64.2.10:3306 []</span>
</code></pre></div>
<p><br>By bringing up tablets in a previously empty
<a href="http://vitess.io/overview/concepts.html#keyspace">keyspace</a>,
you have effectively just created a new
<a href="http://vitess.io/overview/concepts.html#shard">shard</a>.
To initialize the keyspace for the new
shard, call the <code>kvtctl RebuildKeyspaceGraph</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kvtctl RebuildKeyspaceGraph test_keyspace
</code></pre></div>
<p><strong>Note:</strong> Many <code>vtctlclient</code> commands produce no output on
success.<br><br></p>

<p>After this command completes, go back to the <code>vtctld</code>
UI and click the <strong>Topology</strong> link in the top nav bar. You should see the
three tablets listed. If you click the address of a tablet, you
will see the coordination data stored in <code>etcd</code>.<br><br></p>

<p><strong><em>Status pages for vttablets</em></strong></p>

<p>Each <code>vttablet</code> serves a set of HTML status pages on its primary
port. The <code>vtctld</code> interface provides a <strong>[status]</strong> link for
each tablet, but the links are actually to internal, per-pod IPs that can
only be accessed from within Kubernetes.<br><br></p>

<p>As a workaround, you can access tablet status pages through the apiserver
proxy, provided by the Kubernetes master. For example, to see the status
page for the tablet with ID 100 (recall that our Kubernetes master is
on public IP 1.2.3.4), you could navigate to:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://1.2.3.4/api/v1beta3/proxy/namespaces/default/pods/vttablet-100:15002/debug/status
</code></pre></div>
<p>In the future, we plan to have vtctld directly link through this proxy from
the <strong>[status]</strong> link.<br><br></p>

<p><strong><em>Direct connection to mysqld</em></strong></p>

<p>Since the <code>mysqld</code> within the <code>vttablet</code> pod is only
meant to be accessed via vttablet, our default bootstrap settings only allow
connections from localhost.<br><br></p>

<p>If you want to check or manipulate the underlying mysqld,
you can SSH to the Kubernetes node on which the pod is running.
Then use <a href="https://docs.docker.com/reference/commandline/cli/#exec">docker exec</a>
to launch a bash shell inside the mysql container, and connect with the
<code>mysql</code> command-line client:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># For example, to connect to the mysql container within the vttablet-100 pod:</span>
<span class="nv">$ </span>kubectl get pods <span class="p">|</span> grep vttablet-100
<span class="c">### example output:</span>
<span class="c"># vttablet-100 [...] 10.64.2.9    k8s-example-3c0115e4-node-x6jc  [...]</span>
<span class="nv">$ </span>gcloud compute ssh k8s-example-3c0115e4-node-x6jc
k8s-example-3c0115e4-node-x6jc:~<span class="nv">$ </span>sudo docker ps <span class="p">|</span> grep vttablet-100
<span class="c">### example output:</span>
<span class="c"># ef40b4ff08fa   vitess/lite:latest [...]  k8s_mysql.16e2a810_vttablet-100[...]</span>
k8s-example-3c0115e4-node-x6jc:~<span class="nv">$ </span>sudo docker <span class="nb">exec</span> -ti ef40b4ff08fa bash
<span class="c"># Now you&#39;re in a shell inside the mysql container.</span>
<span class="c"># We need to tell the mysql client the username and socket file to use.</span>
vttablet-100:/# <span class="nv">TERM</span><span class="o">=</span>ansi mysql -u vt_dba -S /vt/vtdataroot/vt_0000000100/mysql.sock
</code></pre></div></li>
<li><p><strong>Elect a master vttablet</strong></p>

<p>The tablets are all started as replicas. In this step, you
designate one of the tablets to be the master. Vitess
automatically connects the other replicas&#39; mysqld instances
so that they start replicating from the master&#39;s mysqld.<br><br></p>

<p>Since this is the first time the shard has been started,
the tablets are not already doing any replication, and the
tablet types are all replica or spare. As a
result, the following command uses the <code>-force</code>
flag when calling the <code>InitShardMaster</code> command
to be able to promote one instance to master.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kvtctl InitShardMaster -force test_keyspace/0 <span class="nb">test</span>-0000000100
</code></pre></div>
<p><br><strong>Note:</strong> If you do not include the <code>-force</code> flag
here, the command will first check to ensure the provided
tablet is the only tablet of type master in the shard.
However, since none of the slaves are masters, and we&#39;re not
replicating at all, that check would fail and the command
would fail as well.<br><br></p>

<p>After running this command, go back to the <strong>Topology</strong> page
in the <code>vtctld</code> web interface. When you refresh the
page, you should see that one tablet is the master
and the other two are replicas.<br><br></p>

<p>You can also run this command on the command line to see the
same data:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kvtctl ListAllTablets <span class="nb">test</span>
<span class="c"># The command&#39;s output is shown below:</span>
<span class="c"># test-0000000100 test_keyspace 0 master MASTER_IP:15002 MASTER_IP:3306 []</span>
<span class="c"># test-0000000101 test_keyspace 0 replica REPLICA_IP:15002 REPLICA_IP:3306 []</span>
<span class="c"># test-0000000102 test_keyspace 0 replica REPLICA_IP:15002 REPLICA_IP:3306 []</span>
</code></pre></div></li>
<li><p><strong>Create a table</strong></p>

<p>The <code>vtctlclient</code> tool can be used to apply the database schema
across all tablets in a keyspace. The following command creates
the table defined in the <code>create_test_table.sql</code> file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Make sure to run this from the examples/kubernetes dir, so it finds the file.</span>
vitess/examples/kubernetes<span class="nv">$ </span>kvtctl ApplySchema -sql <span class="s2">&quot;$(cat create_test_table.sql)&quot;</span> test_keyspace
</code></pre></div>
<p><br>The SQL to create the table is shown below:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">CREATE TABLE test_table (
id BIGINT AUTO_INCREMENT,
msg VARCHAR(250),
PRIMARY KEY(id)
) Engine=InnoDB
</code></pre></div>
<p><br>You can run this command to confirm that the schema was created
properly on a given tablet, where <code>test-0000000100</code>
is a tablet alias as shown by the <code>ListAllTablets</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">kvtctl GetSchema <span class="nb">test</span>-0000000100
<span class="c">### example output:</span>
<span class="c"># {</span>
<span class="c">#   &quot;DatabaseSchema&quot;: &quot;CREATE DATABASE `` /*!40100 DEFAULT CHARACTER SET utf8 */&quot;,</span>
<span class="c">#   &quot;TableDefinitions&quot;: [</span>
<span class="c">#     {</span>
<span class="c">#       &quot;Name&quot;: &quot;test_table&quot;,</span>
<span class="c">#       &quot;Schema&quot;: &quot;CREATE TABLE `test_table` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `msg` varchar(250) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8&quot;,</span>
<span class="c">#       &quot;Columns&quot;: [</span>
<span class="c">#         &quot;id&quot;,</span>
<span class="c">#         &quot;msg&quot;</span>
<span class="c">#       ],</span>
<span class="c"># ...</span>
</code></pre></div></li>
<li><p><strong>Start <code>vtgate</code></strong></p>

<p>Vitess uses <code>vtgate</code> to route each client query
to the correct <code>vttablet</code>. In Kubernetes, a
<code>vtgate</code> service distributes connections to a pool
of <code>vtgate</code> pods. The pods are curated by a <a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/replication-controller.md">replication
controller</a>.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./vtgate-up.sh
</code></pre></div></li>
</ol>

<h2 id="test-your-instance-with-a-client-app">Test your instance with a client app</h2>

<p>The GuestBook app in the example is ported from the
<a href="https://github.com/GoogleCloudPlatform/kubernetes/tree/master/examples/guestbook-go">Kubernetes GuestBook example</a>.
The server-side code has been rewritten in Python to use Vitess as the storage
engine. The client-side code (HTML/JavaScript) is essentially unchanged.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes<span class="nv">$ </span>./guestbook-up.sh
</code></pre></div>
<p>As with the <code>vtctld</code> service, to access the GuestBook
app from outside Kubernetes, we need to set the <code>type</code> field in the
service definition to something that generates an external service.</p>

<p>In this case, since this is a user-facing frontend, we use
<code>type: LoadBalancer</code>, which tells Kubernetes to create a public
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md#type--loadbalancer">load balancer</a>
using the API for whatever platform your Kubernetes cluster is in.</p>

<p>As before, you also need to allow access through your platform&#39;s firewall:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># For example, to open port 80 in the GCE firewall:</span>
<span class="nv">$ </span>gcloud compute firewall-rules create guestbook --allow tcp:80
</code></pre></div>
<p>Then, get the external IP of the load balancer for the GuestBook service:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>kubectl get -o yaml service guestbook
<span class="c">### example output:</span>
<span class="c"># apiVersion: v1beta3</span>
<span class="c"># kind: Service</span>
<span class="c"># ...</span>
<span class="c"># status:</span>
<span class="c">#   loadBalancer:</span>
<span class="c">#     ingress:</span>
<span class="c">#     - ip: 3.4.5.6</span>
</code></pre></div>
<p>If the status shows <code>loadBalancer: {}</code>, it may just need more time.</p>

<p>Once the pods are running, the GuestBook app should be accessible
from the load balancer&#39;s external IP. In the example above, it would be at
<code><a href="http://3.4.5.6">http://3.4.5.6</a></code>.</p>

<p>You can see Vitess&#39; replication capabilities by opening the app in
multiple browser windows. Each new entry is committed to the master
database. In the meantime, JavaScript on the page continuously polls
the app server to retrieve a list of GuestBook entries. The app serves
read-only requests by querying Vitess in &#39;replica&#39; mode, confirming
that replication is working.</p>

<p>You can also monitor what each tablet is doing by viewing the vttablet status
page, as described above. For example, you can see the <em>Query Stats</em> change as
you hit the frontend.</p>

<p>The <a href="https://github.com/youtube/vitess/tree/master/examples/kubernetes/guestbook">GuestBook source code</a>
provides more detail about how the app server interacts with Vitess.</p>

<h2 id="tear-down-and-clean-up">Tear down and clean up</h2>

<p>Before stopping the Container Engine cluster, you should tear down the Vitess
services. Kubernetes will then take care of cleaning up any entities it created
for those services, like external load balancers.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vitess/examples/kubernetes <span class="nv">$ </span>./guestbook-down.sh
vitess/examples/kubernetes <span class="nv">$ </span>./vtgate-down.sh
vitess/examples/kubernetes <span class="nv">$ </span>./vttablet-down.sh
vitess/examples/kubernetes <span class="nv">$ </span>./vtctld-down.sh
vitess/examples/kubernetes <span class="nv">$ </span>./etcd-down.sh
</code></pre></div>
<p>Then tear down the Container Engine cluster itself, which will stop the virtual
machines running on Compute Engine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud alpha container clusters delete example
</code></pre></div>
<p>It&#39;s also a good idea to remove the firewall rules you created, unless you plan
to use them again soon:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>gcloud compute firewall-rules delete vtctld guestbook
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>

<p>If a pod enters the <code>Running</code> state, but the server
doesn&#39;t respond as expected, use the <code>kubectl logs</code>
command to check the pod output:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># show logs for container &#39;vttablet&#39; within pod &#39;vttablet-100&#39;</span>
<span class="nv">$ </span>kubectl logs vttablet-100 vttablet

<span class="c"># show logs for container &#39;mysql&#39; within pod &#39;vttablet-100&#39;</span>
<span class="nv">$ </span>kubectl logs vttablet-100 mysql
</code></pre></div>
<p>Post the logs somewhere and send a link to the <a href="https://groups.google.com/forum/#!forum/vitess">Vitess
mailing list</a>
to get more help.</p>

  </div>

</main>

               </section>
            </div>
         </div>
         <footer>
            <div class="s-12">
               <div style="float: left; display: inline-block; width: 50%;">&copy; 2015 Google. Licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</div>
               <div style="float: right; display: inline-block; text-align: right; width: 50%;">Design and coding based on <a href="http://www.myresponsee.com" title="Responsee - lightweight responsive framework">Responsee</a> framework</div>
               </div>
         </footer>
      </div>
      <!-- FOOTER -->

      <script src="/assets/scripts/main.js"></script>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  if (window.location.hostname == 'youtube.github.io') {
    ga('create', 'UA-60219601-1', 'auto');
    ga('send', 'pageview');
  }
</script>

   </body>
</html>
