<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vitess / Horizontal Sharding</title>

        <!-- Webfont -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <link href="/libs/font-awesome-4.4.0/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css">
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <!-- metadata -->
    <meta name="og:title" content="Vitess / Horizontal Sharding"/>
    <meta name="og:image" content="/images/120x120.gif"/>
    <meta name="og:description" content="Servers and tools that scale MySQL databases for the web in cloud architectures or on dedicated hardware."/>
  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


  	<nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess-logo-large-cropped-2.png" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Guides</a></li>
        <li><a href="/reference/vitess-api.html">Reference</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

        <li><a href="https://github.com/youtube/vitess" style="font-size: 18px; margin-left: 0.25em;"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>



<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Horizontal Sharding</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-3" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/concepts.html">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li><a href="/getting-started/">Run Vitess on Kubernetes</a></li>
            <li><a href="/getting-started/local-instance.html">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction.html">Introduction</a>
            <li><a href="/user-guide/client-libraries.html">Client Libraries</a>
            <li><a href="/user-guide/backup-and-restore.html">Backing Up Data</a>
            <li><a href="/user-guide/reparenting.html">Reparenting</a></li>
            <li><a href="/user-guide/schema-management.html">Schema Management</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding.html">Sharding</a>
              <ul style="list-style-type: none">
                <li><a href="/user-guide/horizontal-sharding.html">Horizontal Sharding (Codelab)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes.html">Sharding in Kubernetes (Codelab)</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api.html">Vitess API</a>
            <li><a href="/reference/vtctl.html">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations.html">Presentations</a>
          </ul>
        </li>

      </ul>
    </div>
    <div class="col-md-2" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <p>This step-by-step guide explains how to split an unsharded keyspace into two shards. (An unsharded keyspace has exactly one shard.) The examples assume that the keyspace is named <code>user_keyspace</code> and the shard is <code>0</code>. The sharded keyspace will use the <code>user_keyspace_id</code> column as the keyspace ID.</p>

<p>You can use the same general instructions to reshard a sharded keyspace.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To complete these steps, you must have:</p>

<ol>
<li>A running <a href="/overview/concepts.html#keyspace">keyspace</a>. A keyspace is a logical database that maps to one or more MySQL databases.</li>
<li>Two or more <code>rdonly</code> tablets running on the source shard.<br><br>
Having at least two <code>rdonly</code> tablets ensures that data updates that occur on the source shard during the resharding process propagate to the destination shard. Steps 3 and 4 of the resharding process discuss this in more detail.</li>
</ol>

<p>We recommend that you also review the
<a href="http://vitess.io/user-guide/sharding.html#range-based-sharding">range-based sharding</a>
section of the <em>Sharding</em> guide.</p>

<h2 id="step-1-define-your-keyspace-id-on-the-source-shard">Step 1: Define your Keyspace ID on the Source Shard</h2>

<p><strong>Note:</strong> Skip this step if your keyspace already has multiple shards.</p>

<p>In this step, you add a column, which will serve as the <a href="/overview/concepts#keyspace-id">keyspace ID</a> (or sharding key), to each table in the soon-to-be-sharded keyspace. After the keyspace has been sharded, Vitess will use the column&#39;s value to route each query to the proper shard.</p>

<h3 id="step-1-1-add-keyspace-id-to-each-database-table">Step 1.1: Add keyspace ID to each database table</h3>

<p>For each table in the unsharded keyspace, run the following <code>alter</code> statement:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl ApplySchema <span class="se">\</span>
      -sql<span class="o">=</span><span class="s2">&quot;alter table &lt;table name&gt; add &lt;keyspace ID column&gt;&quot;</span> <span class="se">\</span>
      &lt;keyspace name&gt;
</code></pre></div>
<p>In this example, the command looks like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl ApplySchema <span class="se">\</span>
      -sql<span class="o">=</span><span class="s2">&quot;alter table &lt;table name&gt; add user_keyspace_id&quot;</span> <span class="se">\</span>
      user_keyspace
</code></pre></div>
<p>In the above statement, replace <code>user_keyspace_id</code> with the column name that you want to use to store the keyspace ID value. Also replace <code>user_keyspace</code> with the name of your keyspace.</p>

<h3 id="step-1-2-update-tables-to-contain-keyspace-id-values">Step 1.2: Update tables to contain keyspace ID values</h3>

<p>Backfill each row in each table with the appropriate keyspace ID value. In this example, each <code>user_keyspace_id</code> column contains a 64-bit hash of the user ID in that column&#39;s row.</p>

<h3 id="step-1-3-set-keyspace-id-in-topology-server">Step 1.3: Set keyspace ID in topology server</h3>

<p>Tell Vitess which column value identifies the keyspace ID by running the following command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl SetKeyspaceShardingInfo &lt;keyspace name&gt; <span class="se">\</span>
      &lt;keyspace ID column&gt; &lt;keyspace <span class="nb">type</span>&gt;
</code></pre></div>
<p>In this example, the command looks like this:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl SetKeyspaceShardingInfo user_keyspace user_keyspace_id uint64
</code></pre></div>
<p>Note that each table in the keyspace must have a column to identify the keyspace ID. In addition, all of those columns must have the same name.</p>

<h2 id="step-2-prepare-the-destination-shards">Step 2: Prepare the destination shards</h2>

<p>In this step, you create the destination shards and tablets. At the end of this step, the destination shards will have been created, but they will not contain any data and will not serve any traffic.</p>

<p>This example shows how to split an unsharded database into two destination shards. As noted in the <a href="sharding-keys">sharding keys</a> section, the value [ 0x80 ] is the middle value for sharding keys. So, when you split this database into two shards, the <a href="#range-based-shard-names">range-based shard names</a> for those shards will be:</p>

<ul>
<li>-80</li>
<li>80-</li>
</ul>

<h3 id="step-2-1-create-destination-shards">Step 2.1: Create destination shards</h3>

<p>To create the destination shards, call the <code>CreateShard</code> command.
You would have used the same command to create the source shard. Repeat the
following command for each shard you need to create:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl CreateShard &lt;keyspace name&gt;/&lt;shard name&gt;
</code></pre></div>
<p>In this example, you would run the command twice:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl CreateShard user_keyspace/80-
vtctl CreateShard user_keyspace/-80
</code></pre></div>
<h3 id="step-2-2-create-destination-tablets">Step 2.2: Create destination tablets</h3>

<p>To create the destination master tablets, call the
<code>InitTablet</code> command. Then call the <code>InitShardMaster</code>
command to initialize MySQL replication in each destination shard.
You would have used the same commands to create the master tablet on the
source shard.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl InitTablet -keyspace<span class="o">=</span>&lt;keyspace name&gt; -shard<span class="o">=</span>&lt;shard name&gt; <span class="se">\</span>
                 &lt;tablet <span class="nb">alias</span>&gt; &lt;tablet <span class="nb">type</span>&gt;
vtctl InitShardMaster -force &lt;keyspace name&gt;/&lt;shard name&gt; <span class="se">\</span>
                      &lt;tablet <span class="nb">alias</span>&gt;
</code></pre></div>
<p>In this example, you would run these commands:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl InitTablet -keyspace<span class="o">=</span>user_keyspace -shard<span class="o">=</span>-80 &lt;tablet <span class="nb">alias</span>&gt; <span class="se">\</span>
                 master
vtctl InitShardMaster -force user_keyspace/-80 &lt;tablet <span class="nb">alias</span>&gt;

vtctl InitTablet -keyspace<span class="o">=</span>user_keyspace -shard<span class="o">=</span>user_keyspace/80- <span class="se">\</span>
                 &lt;tablet <span class="nb">alias</span>&gt; master
vtctl InitShardMaster -force user_keyspace/80- &lt;tablet <span class="nb">alias</span>&gt;
</code></pre></div>
<h3 id="step-2-3-create-rdonly-tablets-in-destination-shards">Step 2.3: Create rdonly tablets in destination shards</h3>

<p>Each destination shard should have two rdonly tablets. Again, use the
<code>InitTablet</code> command to create each tablet.</p>

<p>In this example, you would run these commands to create two rdonly tablets
in each of the two destination shards:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl InitTablet -keyspace=user_keyspace -shard=-80 &lt;tablet alias&gt; \
                 rdonly
vtctl InitTablet -keyspace=user_keyspace -shard=-80 &lt;tablet alias&gt; \
                 rdonly

vtctl InitTablet -keyspace=user_keyspace -shard=80- &lt;tablet alias&gt; \
                 rdonly
vtctl InitTablet -keyspace=user_keyspace -shard=80- &lt;tablet alias&gt; \
                 rdonly
</code></pre></div>
<h2 id="step-3-clone-data-to-the-destination-shards">Step 3: Clone data to the destination shards</h2>

<p>In this step, you copy the database schema to each destination shard.
Then you copy the data to the destination shards. At the end of this
step, the destination tablets will be populated with data but will not
yet be serving traffic.</p>

<h3 id="step-3-1-copy-schema-to-destination-shards">Step 3.1: Copy schema to destination shards</h3>

<p>Call the <code>CopySchemaShard</code> command to copy the database schema
from a rdonly tablet on the source shard to the destination shards:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl CopySchemaShard &lt;<span class="nb">source </span>rdonly tablet <span class="nb">alias</span>&gt; <span class="se">\</span>
                      &lt;keyspace name&gt;/&lt;shard name&gt;
</code></pre></div>
<p>In this example, you would run these two commands:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl CopySchemaShard &lt;<span class="nb">source </span>rdonly tablet <span class="nb">alias</span>&gt; user_keyspace/-80
vtctl CopySchemaShard &lt;<span class="nb">source </span>rdonly tablet <span class="nb">alias</span>&gt; user_keyspace/80-
</code></pre></div>
<h3 id="step-3-2-copy-data-from-source-shard-to-destination-shards">Step 3.2: Copy data from source shard to destination shards</h3>

<p>This step uses a vtworker process to copy data from the source shard
to the destination shards. The vtworker performs the following tasks:</p>

<ol>
<li>It finds an rdonly tablet on the source shard and stops data
replication on the tablet. This prevents the data from changing
while it is being copied. During this time, the rdonly tablet&#39;s
status is changed to <code>spare</code>, and the tablet is removed
from the serving graph since it might not have up-to-date data.</li>
<li>It does a (concurrent) full scan of each table on the source shard.</li>
<li>It identifies the appropriate destination shard for each source row
based on the row&#39;s sharding key.</li>
<li>It streams the data to the master tablet on the correct destination shard.</li>
</ol>

<p>The following command starts the vtworker:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtworker --min_healthy_rdonly_endpoints 1 --cell=&lt;cell name&gt; \
         SplitClone --strategy=-populate_blp_checkpoint \
         &lt;keyspace name&gt;/&lt;source shard name&gt;
</code></pre></div>
<p>For this example, run this command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtworker --min_healthy_rdonly_endpoints 1 --cell=&lt;cell name&gt; \
         SplitClone --strategy=-populate_blp_checkpoint user_keyspace/0
</code></pre></div>
<p>The amount of time that the worker takes to complete will depend
on the size of your dataset. When the process completes, the destination
shards contain the correct data but do not yet serve traffic.
The destination shards are also now running
<a href="#filtered-replication">filtered replication</a>.</p>

<h3 id="step-3-3-restore-rdonly-tablet-on-source-shard">Step 3.3: Restore rdonly tablet on source shard</h3>

<p>The source tablet is not automatically returned to the serving graph.
Use the following command to change the tablet&#39;s type back to
<code>rdonly</code> and have the tablet catch up on replication:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl ChangeSlaveType &lt;<span class="nb">source </span>rdonly tablet <span class="nb">alias</span>&gt; rdonly
</code></pre></div>
<h2 id="step-4-run-a-data-diff-to-verify-accuracy">Step 4: Run a data diff to verify accuracy</h2>

<p>Before the destination shard starts serving data, you want to ensure that
its data is up-to-date. Remember that the source tablet would not have
received updates to any of its records while the vtworker process was
copying data to the destination shards.</p>

<h3 id="step-4-1-use-filtered-replication-to-catch-up-to-source-data-changes">Step 4.1: Use filtered replication to catch up to source data changes</h3>

<p>Vitess uses <a href="#filtered-replication">filtered replication</a> to ensure that
data changes on the source shard during step 3 propagate successfully
to the destination shards. While this process happens automatically, the
time it takes to complete depends on how long step 3 took to complete and
the scope of the data changes on the source shard during that time.</p>

<p>You can see the filtered replication state for a destination shard by
viewing the status page of the shard&#39;s master tablet in your browser.
The Binlog Player table shows a <strong>SecondsBehindMaster</strong> column that
indicates how far the destination master is still behind the source shard.</p>

<h3 id="step-4-2-compare-data-on-source-and-destination-shards">Step 4.2: Compare data on source and destination shards</h3>

<p>In this step, you use another vtworker process to ensure that the data
on the source and destination shards is identical. The vtworker can also
catch potential problems that might have occurred during the copying
process. For example, if the sharding key changed for a particular row
during step 3 or step 4.1, the data on the source and destination shards
might not be equal.</p>

<p>To start the vtworker, run the following <code>SplitDiff</code> command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtworker -min_healthy_rdonly_endpoints<span class="o">=</span><span class="m">1</span> --cell<span class="o">=</span>&lt;cell name&gt; <span class="se">\</span>
         SplitDiff &lt;keyspace name&gt;/&lt;shard name&gt;
</code></pre></div>
<p>The command for the first new destination shard in this example is shown
below. You need to complete this process for each destination shard.
However, you must remove one rdonly tablet from the source shard for each
diff process that is running. As such, it is recommended to run diffs
sequentially rather than in parallel.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtworker -min_healthy_rdonly_endpoints<span class="o">=</span><span class="m">1</span> --cell<span class="o">=</span>&lt;cell name&gt; <span class="se">\</span>
         SplitDiff user_keyspace/-80
</code></pre></div>
<p>The vtworker performs the following tasks:</p>

<ol>
<li>It finds a health rdonly tablet in the source shard and a healthy
rdonly tablet in the destination shard.</li>
<li>It removes both tablets from the serving graph so data can be compared
reliably.</li>
<li>It pauses filtered replication on the destination master tablet.</li>
<li>It pauses replication on the source rdonly tablet at a position higher
than the destination master&#39;s filtered replication position.</li>
<li>It resumes the destination master&#39;s filtered replication.</li>
<li>It allows the destination rdonly tablet to catch up to the same position
as the source rdonly tablet and then stops replication on the
destination rdonly tablet.</li>
<li>It compares the schema on the source and destination rdonly tablets.</li>
<li>It streams data from the source and destination tablets, using the
same sharding key constraints, and verifies that the data is equal.</li>
</ol>

<p>If the diff is successful on the first destination shard, repeat it
on the next destination shard.</p>

<h3 id="step-4-3-return-tablets-to-serving-graph">Step 4.3: Return tablets to serving graph</h3>

<p>Put the source and destination rdonly tablets used in step 4.2 back into
the serving graph:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl ChangeSlaveType &lt;source rdonly tablet alias&gt; rdonly
vtctl ChangeSlaveType &lt;destination rdonly tablet alias&gt; rdonly
</code></pre></div>
<h2 id="step-5-direct-traffic-to-destination-shards">Step 5: Direct traffic to destination shards</h2>

<p>After verifying that your destination shards contain the correct data, you can start serving traffic from those shards.</p>

<h3 id="step-5-1-migrate-read-only-traffic">Step 5.1 Migrate read-only traffic</h3>

<p>The safest process is to migrate read-only traffic first. You will migrate
write operations in the following step, after the read-only traffic is
stable. The reason for splitting the migration into two steps is that
you can reverse the migration of read-only traffic without creating data
inconsistencies. However, you cannot reverse the migration of master
traffic without creating data inconsistencies.</p>

<p>Use the <code>MigrateServedTypes</code> command to migrate <strong>rdonly</strong>
and <strong>replica</strong> traffic:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; rdonly
vtctl MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; replica
</code></pre></div>
<p>If something goes wrong during the migration of read-only traffic,
run the same commands with the <code>reverse</code> flag to return
read-only traffic to the source shard:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl MigrateServedTypes -reverse &lt;keyspace name&gt;/&lt;source shard name&gt; \
                         rdonly
vtctl MigrateServedTypes -reverse &lt;keyspace name&gt;/&lt;source shard name&gt; \
                         replica
</code></pre></div>
<h3 id="step-5-2-migrate-master-traffic">Step 5.2 Migrate master traffic</h3>

<p>Use the <code>MigrateServedTypes</code> command again to migrate <strong>master</strong>
traffic to the destination shard:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl MigrateServedTypes &lt;keyspace name&gt;/&lt;source shard name&gt; master
</code></pre></div>
<p>For this example, the command is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">vtctl MigrateServedTypes user_keyspace/0 master
</code></pre></div>
<h2 id="step-6-scrap-source-shard">Step 6: Scrap source shard</h2>

<p>If all of the other steps were successful, you can remove the source
shard, which should no longer be in use.</p>

<h3 id="step-6-1-remove-source-shard-tablets">Step 6.1: Remove source shard tablets</h3>

<p>Run the following commands for each tablet in the source shard:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl ScrapTablet &lt;<span class="nb">source </span>tablet <span class="nb">alias</span>&gt;<span class="sb">`</span>
vtctl DeleteTablet &lt;<span class="nb">source </span>tablet <span class="nb">alias</span>&gt;<span class="sb">`</span>
</code></pre></div>
<h3 id="step-6-2-rebuild-serving-graph">Step 6.2: Rebuild serving graph</h3>

<p>Run the following command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl RebuildKeyspaceGraph &lt;keyspace name&gt;
</code></pre></div>
<p>For this example, the command is:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl RebuildKeyspaceGraph user_keyspace
</code></pre></div>
<h3 id="step-6-3-delete-source-shard">Step 6.3: Delete source shard</h3>

<p>Run the following command:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl DeleteShard &lt;keyspace name&gt;/&lt;<span class="nb">source </span>shard name&gt;
</code></pre></div>
<p>For this example, the command is:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">vtctl DeleteShard user_keyspace/0
</code></pre></div>
      </div>
    </div>
  </div>

</div>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


    <!-- GA -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-60219601-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
